import{e as j,f as U,c as v,o as f,r as B,g as k,h as c,F as z,i as M,m as q,j as E,k as x,l as J,n as G,p as H,q as K,s as $,v as Q,b,w as N,d as V,a as l,t as A,x as W,y as X,z as Y,A as Z,B as ee}from"./wS51j1LK.js";import{_ as te}from"./KqLL-eAz.js";import{getShoppingListsChannelName as ne}from"./CMMJH2nf.js";import{u as se,s as y,r as R,a as oe,k as ae,g as ie,h as re}from"./BuNAydTJ.js";const le={class:"list"},ce={key:0,class:"list-row"},de=j({__name:"BaseList",props:{items:{},itemProps:{type:Function}},setup(L){const s=L,a=U();return(d,u)=>(f(),v("ul",le,[B(d.$slots,"static"),B(d.$slots,"default",{},()=>[s.items?.length?(f(!0),v(z,{key:0},M(s.items,p=>(f(),v("li",q({class:"list-row"},{ref_for:!0},s.itemProps?.(p),{key:p.id}),[B(d.$slots,"item",{item:p})],16))),128)):k("",!0)]),!s.items?.length&&c(a).empty?(f(),v("li",ce,[B(d.$slots,"empty")])):k("",!0)]))}}),ue=Object.assign(de,{__name:"BaseList"});async function pe(L){const s=E(()=>ne()),a=x(!1),d=x(null),u=x(new Map),{data:p,pending:F,error:I,refresh:O}=se("shoppingLists",async()=>{const e=await y.getShoppingListsAsync();return R(e)},{getCachedData(e){const n=J(),t=n.payload.data[e]||n.static.data[e];if(!t)return;const o=new Date(t.fetchedAt);if(o.setTime(o.getTime()+300*1e3),new Date<o)return t},server:!1,...L}),{listToSync:_,getItem:m,upsertItem:r,deleteItem:C,releaseAction:S,isActionBlocked:D,blockAction:h}=oe(p);async function i(){u.value.has(s.value)&&u.value.get(s.value)&&y.unsubscribe(u.value.get(s.value));async function e(n){try{const t=ae(n),o=ie(t);if(D(t.record?.id??t.oldRecord?.id,o))return;switch(o){case"insert":{r({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date,productAmount:t.record.productAmount},0);break}case"update":r({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date});break;case"delete":C(t.oldRecord.id);break;default:throw new Error("Invalid payload")}}catch(t){console.error(t)}}return u.value.set(s.value,y.listenForShoppingListsChanges(e)),u.value.get(s.value)}async function w(e){if(e.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");a.value=!0;const n=new Date,t=n.valueOf()*2;return h(t,"insert"),r({id:t,createdAt:n.toISOString(),name:e.name,date:new Intl.DateTimeFormat("pl-PL").format(n),productAmount:0},0),y.createShoppingListAsync(e.name).then(o=>{const P=R(o);return r(P,0,!0),o}).catch(o=>(console.error(o),o)).finally(()=>{a.value=!1,S(t,"insert")})}async function T(e){if(e.name?.trim()==="")throw new Error("Nazwa powinna być wypełniona");const n=m(e.id);return a.value=!0,h(e.id,"update"),r({...e},n.index),y.updateShoppingListAsync(e.id,e.name,e.date).then(t=>{const o=R(t);return r(o,n.index),t}).catch(t=>(console.error(t),r(n.item,n.index),t)).finally(()=>{a.value=!1,S(e.id,"update")})}async function g(e){const n=m(e.id);return a.value=!0,h(e.id,"delete"),C(e.id),y.deleteShoppingListAsync(e.id).catch(t=>(console.error(t),r(n.item,n.index),t)).finally(()=>{a.value=!1,S(e.id,"delete")})}return G(()=>{H(L?.useAutoListenFor)?.includes("shoppingListsChanges")&&i()}),K(()=>{try{u.value.forEach(e=>{y.unsubscribe(e)})}catch(e){console.error(e)}}),{shoppingLists:$(_),loading:$(E(()=>F.value||a.value)),error:$(E(()=>I.value||d.value)),refresh:O,listenForShoppingListsChanges:i,addShoppingList:w,updateShoppingList:T,deleteShoppingList:g}}const me={class:"card flex justify-center max-w-xl m-auto"},he={class:"p-4 grid grid-cols-[80px_1fr]"},ge={class:"col-2 justify-self-end"},fe={class:"list-col-grow"},_e=["aria-invalid","placeholder"],ye={key:0,class:"validator-hint hidden"},ve={class:"btn btn-ghost btn-circle"},we=["onClick"],Le={key:0},xe=j({__name:"index",async setup(L){let s,a;const{shoppingLists:d,loading:u,error:p,addShoppingList:F,deleteShoppingList:I,updateShoppingList:O}=([s,a]=Q(()=>pe({useAutoListenFor:["shoppingListsChanges"]})),s=await s,a(),s),_=x(""),m=x("");async function r(h){F({name:m.value||D()}).then(i=>{re(i),h.currentTarget?.reset(),S()}).catch(i=>{_.value=i.toString()})}async function C(h){I({id:h})}function S(){m.value="",_.value=""}function D(){return new Intl.DateTimeFormat("pl-PL").format(new Date)}return(h,i)=>{const w=W,T=te;return f(),v("div",me,[b(ue,{class:"card-body bg-base-100 rounded-box shadow-md w-full",items:c(d)},{static:N(()=>[l("li",he,[c(u)?(f(),X(w,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):k("",!0),l("span",ge,"List: "+A(c(d).length),1)]),l("li",null,[l("form",{class:"list-row",onSubmit:r},[l("label",fe,[Y(l("input",{"onUpdate:modelValue":i[0]||(i[0]=g=>Z(m)?m.value=g:null),"aria-invalid":!!c(_),class:"input input-ghost validator",placeholder:D(),type:"text"},null,8,_e),[[ee,c(m)]]),c(_).trim()?(f(),v("span",ye,A(c(_)),1)):k("",!0)]),l("button",ve,[b(w,{name:"streamline-freehand:add-sign-bold"})])],32)])]),item:N(({item:g})=>[b(T,{to:{name:"lists-id",params:{id:g.id}},class:"list-col-grow"},{default:N(()=>[l("span",null,A(g.name),1)]),_:2},1032,["to"]),l("span",null,[V(A(g.productAmount)+" ",1),b(w,{name:"streamline-freehand:shopping-cart-trolley"})]),l("button",{onClick:e=>C(g.id)},[b(w,{name:"streamline-freehand:remove-delete-sign-bold"})],8,we)]),empty:N(()=>i[1]||(i[1]=[V("Brak list",-1)])),_:1},8,["items"]),c(p)?(f(),v("div",Le,A(c(p)),1)):k("",!0)])}}});export{xe as default};
