import{A as ge,e as q,r as _,g as fe,h as W,i as me,j as ee,f as he,k as ve,B as ye,l as re,C as ie,D as we,c as l,a as o,m as B,b as J,n as be,w as _e,p as n,q as te,s as ne,v as le,d as ue,F as N,z as P,E as ke,G as se,t as m,o as i,y as xe,H as oe}from"./yZ0CCdce.js";import{_ as Ce}from"./Cv-k4ZqD.js";import{UnitEnum as V,getShoppingListChannelName as Ae,groupProductsByCategoryJs as Ie}from"./BT9xwcxX.js";import{b as Le,u as de,s as I,r as K,a as Se,k as H,g as De,c as Ee,p as Te}from"./7aPHw-C9.js";async function $e(E,d){const w=ge(E),L=q(()=>ce(W(w))),S=q(()=>Ae(W(L))),T=_(!1),Q=_(null),k=_(new Map),{data:v}=Le("categories"),{data:X,pending:O,error:c,refresh:G}=de(`shoppingListDetails:${L.value}`,async()=>{const a=await I.getShoppingListAsync(L.value);return K(a)},{getCachedData(a){const g=he(),r=g.payload.data[a]||g.static.data[a];if(!r)return;const y=new Date(r.fetchedAt);if(y.setTime(y.getTime()+300*1e3),new Date<y)return r},server:!1,...d}),{listToSync:u,getItem:x,upsertItem:h,deleteItem:p,releaseAction:M,isActionBlocked:U,blockAction:C}=Se(X);async function j(){k.value.has(S.value)&&k.value.get(S.value)&&I.unsubscribe(k.value.get(S.value));async function a(g){try{const r=H(g),y=De(r);if(U(r.record?.id??r.oldRecord?.id,y))return;switch(y){case"insert":{const b=I.getShoppingListProductAsync(r.record.id);if(!v.value)throw new Error("Categories not found");const D=v.value?.find(R=>R.id===r.record?.categoryId)??v.value?.[0];if(!D)throw new Error("Category not found");h({id:r.record.id,createdAt:new Date().toISOString(),quantity:r.record.quantity,unit:V.GRAM.name,name:"Ładowanie...",inCart:r.record.inCart,category:D});const z=await b,F=K(z);h(F);break}case"update":{const b=I.getShoppingListProductAsync(r.record.id);if(!v.value)throw new Error("Categories not found");if(!(v.value?.find(R=>R.id===r.record?.categoryId)??v.value?.[0]))throw new Error("Category not found");h(r.record);const z=await b,F=K(z);h(F);break}case"delete":p(r.oldRecord.id);break;default:throw new Error("Invalid payload")}}catch(r){console.error(r)}}return k.value.set(S.value,I.listenForShoppingListChanges(L.value,a)),k.value.get(S.value)}async function Y(a){if(!u.value)throw new Error("Shopping list not found");const g=x(a);if(!g.item)throw new Error("Product not found");T.value=!0,C(a,"update"),h({id:g.item.id,inCart:g.item.inCart},g.index,!0),I.toggleProductInCartAsync(a).then(r=>{const y=K(r);h(y,g.index,!0)}).catch(r=>{h(g.item,g.index,!0),console.error(r)}).finally(()=>{T.value=!1,M(a,"update")})}async function Z(a){if(a.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");return I.addToShoppingListAsync(ce(a.listId),V.valueOf(a.unit.name),a.quantity,a.name,a.categoryId)}return fe(()=>{W(d?.useAutoListenFor)?.includes("shoppingListChanges")&&j()}),me(()=>{try{k.value.forEach(a=>{I.unsubscribe(a)})}catch(a){console.error(a)}}),{shoppingListDetails:ee(u),loading:ee(q(()=>O.value||T.value)),error:ee(q(()=>c.value||Q.value)),refresh:G,listenForShoppingListChanges:j,toggleInCart:Y,addToShoppingList:Z,categoriesWithProducts:q(()=>u.value&&v.value?H(Ie(u.value,v.value)):[])}}function ce(E){const d=Array.isArray(E)?E[0]:E;if(d==null)throw new Error(`Invalid list ID. It should be a string or number. Actual value: ${d}`);const w=parseInt(d,10);if(Number.isNaN(w))throw new Error(`Invalid list ID. Is not a number. Actual value: ${d}`);return w}const Be={class:"card flex justify-center flex-col max-w-xl m-auto"},Ne={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},Pe={class:"px-2 inline-flex flex-row gap-2"},qe={class:"list-row-separator"},Me={class:"btn btn-ghost btn-square"},Ue={class:"relative col-span-2"},je=["aria-expanded","aria-activedescendant"],ze={key:0,id:"suggestions-list",class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 menu bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Fe={key:0,class:"disabled",role:"presentation"},Re=["id","aria-selected","onClick","onMouseenter"],Ve={class:"badge badge-ghost badge-sm"},Oe={key:2,class:"disabled",role:"presentation"},Ge=["value"],Je={class:"relative col-span-3"},Ke={key:0,class:"flex items-center gap-2"},He={key:1,class:"opacity-60"},Qe={key:0,class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Xe={key:0,class:"disabled",role:"presentation"},Ye=["aria-selected","onClick"],Ze={class:"inline-flex items-center gap-2"},We={class:"list"},et=["onClick"],tt={class:"list-col-grow"},nt={key:1,class:"list-row"},st={key:1,class:"list-row"},ot={key:0,class:"flex flex-col gap-1"},at={class:"text-error"},ct=ve({__name:"[id]",async setup(E){let d,w;const L=ye(),S=V.values(),{categoriesWithProducts:T,error:Q,loading:k,toggleInCart:v,addToShoppingList:X}=([d,w]=re(()=>$e(L.params.id,{useAutoListenFor:["shoppingListChanges"]})),d=await d,w(),d),O=ie({name:""}),c=ie({name:"",quantity:1,unit:V.GRAM,categoryId:1}),G=q(()=>[Q.value,r.value].filter(Boolean)),u=_([]),x=_(!1),h=_(!1),p=_(-1);let M=null;function U(){u.value.length>0&&(x.value=!0)}function C(){x.value=!1,p.value=-1}function j(s){try{c.name=s.name,c.unit=V.valueOf(s.unit),C()}catch(e){console.error("selectSuggestion->",e)}}async function Y(s){if(!s||s.trim().length<2){u.value=[],C();return}h.value=!0;try{const e=await Te.getProductSuggestionAsync(c.name);if("error"in e){u.value=[],C();return}if(!("result"in e)){u.value=[],C();return}const A=H(e.result);u.value=A||[],U()}finally{h.value=!1}}we(()=>c.name,s=>{M&&clearTimeout(M),M=setTimeout(()=>{Y(s)},250)});function Z(s){if(!x.value&&(s.key==="ArrowDown"||s.key==="ArrowUp")){U();return}x.value&&(s.key==="ArrowDown"?(s.preventDefault(),p.value=u.value.length===0?-1:(p.value+1)%u.value.length):s.key==="ArrowUp"?(s.preventDefault(),p.value=u.value.length===0?-1:(p.value-1+u.value.length)%u.value.length):s.key==="Enter"?p.value>=0&&p.value<u.value.length&&(s.preventDefault(),j(u.value[p.value])):s.key==="Escape"&&C())}function a(){setTimeout(()=>C(),100)}const{data:g,error:r,status:y}=([d,w]=re(async()=>de("categories",async()=>{const s=await Ee.getCategoriesAsync();if("error"in s)throw new Error(s);if(!("result"in s))throw new Error("Unsupported response type: "+s.constructor.name);return H(s.result)},{server:!1})),d=await d,w(),d),$=_(null),b=_(!1),D=s=>{if(!s)return"";const e=s.split(" ");return e.length>1?e.slice(0,2).map(A=>A[0]).join("").toUpperCase():s.slice(0,2).toUpperCase()},z=s=>{$.value=s,b.value=!1,c.categoryId=s.id};async function F(s){X({listId:L.params.id,...c}).then(()=>{s.currentTarget?.reset(),R()}).catch(e=>{O.name=e.message})}function R(){c.name="",c.quantity=1,O.name=""}return(s,e)=>{const A=xe,pe=Ce;return i(),l("div",Be,[o("ul",Ne,[o("li",Pe,[J(pe,{to:"/"},{default:_e(()=>[J(A,{name:"streamline-freehand:keyboard-arrow-return"})]),_:1}),n(k)?(i(),be(A,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):B("",!0)]),o("li",qe,[o("form",{class:"grid grid-cols-[80px_minmax(0,_auto)_45px]",onSubmit:te(F,["prevent"])},[o("button",Me,[J(A,{name:"streamline-freehand:add-sign-bold"})]),o("div",Ue,[ne(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>n(c).name=t),class:"input input-ghost w-full",placeholder:"Nazwa produktu",required:"",type:"text",autocomplete:"off",role:"combobox","aria-autocomplete":"list","aria-expanded":n(x),"aria-controls":"suggestions-list","aria-activedescendant":n(p)>=0?`suggestion-${n(p)}`:void 0,onFocus:e[1]||(e[1]=t=>U()),onBlur:a,onKeydown:Z},null,40,je),[[le,n(c).name]]),n(x)?(i(),l("ul",ze,[n(h)?(i(),l("li",Fe,e[8]||(e[8]=[o("span",{class:"loading loading-spinner loading-sm"},null,-1),ue(" Ładowanie… ",-1)]))):n(u).length>0?(i(!0),l(N,{key:1},P(n(u),(t,f)=>(i(),l("li",{id:`suggestion-${f}`,key:t.id||t.name+f,role:"option",class:oe(["inline-flex flex-row justify-between items-center",{active:f===n(p)}]),"aria-selected":f===n(p),onClick:ae=>j(t),onMouseenter:ae=>p.value=f,onMousedown:e[2]||(e[2]=te(()=>{},["prevent"]))},[o("span",null,m(t.name),1),o("span",Ve,m(t.unit||"szt."),1)],42,Re))),128)):!n(h)&&n(u).length===0?(i(),l("li",Oe,e[9]||(e[9]=[o("span",{class:"opacity-60"},"Brak sugestii",-1)]))):B("",!0)])):B("",!0)]),ne(o("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>n(c).quantity=t),class:"input input-ghost",min:"1",required:"",type:"number"},null,512),[[le,n(c).quantity]]),ne(o("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>n(c).unit=t),class:"select select-ghost col-span-2 w-full"},[e[10]||(e[10]=o("option",{disabled:"",selected:""},"Wybierz jednostkę",-1)),(i(!0),l(N,null,P(n(S),t=>(i(),l("option",{key:t.name,value:t},m(t.name),9,Ge))),128))],512),[[ke,n(c).unit]]),o("div",Je,[o("button",{type:"button",class:"btn btn-ghost w-full justify-between",onClick:e[5]||(e[5]=t=>b.value=!n(b)),onBlur:e[6]||(e[6]=t=>b.value=!1)},[n($)?(i(),l("div",Ke,[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:se({backgroundColor:`#${n($).color}`})},m(D(n($).name)),5),o("span",null,m(n($).name),1)])):(i(),l("span",He,"Wybierz kategorię")),J(A,{name:"mdi:chevron-down",class:"ml-auto"})],32),n(b)?(i(),l("ul",Qe,[n(y)==="pending"?(i(),l("li",Xe,e[11]||(e[11]=[o("span",{class:"loading loading-spinner loading-sm"},null,-1),ue(" Ładowanie… ",-1)]))):B("",!0),(i(!0),l(N,null,P(n(g),t=>(i(),l("li",{key:t.id,role:"option",class:oe([{active:n(c).categoryId===t.id},"inline-flex flex-row w-full items-center gap-3 px-3 py-2 rounded-lg cursor-pointer hover:bg-base-200"]),"aria-selected":n(c).categoryId===t.id,onMousedown:e[7]||(e[7]=te(()=>{},["prevent"])),onClick:f=>z(t)},[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:se({backgroundColor:`#${t.color}`})},m(D(t.name)),5),o("span",null,m(t.name),1)],42,Ye))),128))])):B("",!0)])],32)]),n(T).length?(i(!0),l(N,{key:0},P(n(T),t=>(i(),l("li",{key:t.category.id,class:"category-list"},[o("span",Ze,[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:se({backgroundColor:`#${t.category.color}`})},m(D(t.category.name)),5),o("span",null,m(t.category.name),1)]),o("ul",We,[t.products?.length?(i(!0),l(N,{key:0},P(t.products,f=>(i(),l("li",{key:f.id,class:oe([{"line-through":f.inCart},"list-row"]),onClick:ae=>n(v)(f.id)},[o("span",tt,m(f.name),1),o("span",null,m(f.quantity)+" "+m(f.unit),1)],10,et))),128)):(i(),l("li",nt,"Brak produktów w kategorii"))])]))),128)):(i(),l("li",st,"Brak produktów na liście"))]),n(G).length?(i(),l("div",ot,[(i(!0),l(N,null,P(n(G),t=>(i(),l("span",at,m(t),1))),256))])):B("",!0)])}}});export{ct as default};
