import{e as T,r as S,f as O,g as j,h as M,i as U,j as F,k as z,l as P,c as y,o as f,a,m as E,n as q,p as l,t as L,q as $,s as J,v as G,x as H,b as k,y as K,F as Q,z as W,w as X,d as Y}from"./qcYDViHw.js";import{_ as Z}from"./kj6-xdrY.js";import{getShoppingListsChannelName as ee}from"./sjsuxzjh.js";import{u as te,s as g,r as B,a as ne,k as se,g as ae,h as oe}from"./GvR_L9BH.js";async function ie(C){const o=T(()=>ee()),i=S(!1),v=S(null),u=S(new Map),{data:x,pending:D,error:N,refresh:R}=te("shoppingLists",async()=>{const e=await g.getShoppingListsAsync();return B(e)},{getCachedData(e){const n=O(),t=n.payload.data[e]||n.static.data[e];if(!t)return;const s=new Date(t.fetchedAt);if(s.setTime(s.getTime()+300*1e3),new Date<s)return t},server:!1,...C}),{listToSync:m,getItem:p,upsertItem:r,deleteItem:b,releaseAction:w,isActionBlocked:A,blockAction:h}=ne(x);async function c(){u.value.has(o.value)&&u.value.get(o.value)&&g.unsubscribe(u.value.get(o.value));async function e(n){try{const t=se(n),s=ae(t);if(A(t.record?.id??t.oldRecord?.id,s))return;switch(s){case"insert":{r({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date,productAmount:t.record.productAmount},0);break}case"update":r({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date});break;case"delete":b(t.oldRecord.id);break;default:throw new Error("Invalid payload")}}catch(t){console.error(t)}}return u.value.set(o.value,g.listenForShoppingListsChanges(e)),u.value.get(o.value)}async function _(e){if(e.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");i.value=!0;const n=new Date,t=n.valueOf()*2;return h(t,"insert"),r({id:t,createdAt:n.toISOString(),name:e.name,date:new Intl.DateTimeFormat("pl-PL").format(n),productAmount:0},0),g.createShoppingListAsync(e.name).then(s=>{const V=B(s);return r(V,0,!0),s}).catch(s=>(console.error(s),s)).finally(()=>{i.value=!1,w(t,"insert")})}async function I(e){if(e.name?.trim()==="")throw new Error("Nazwa powinna być wypełniona");const n=p(e.id);return i.value=!0,h(e.id,"update"),r({...e},n.index),g.updateShoppingListAsync(e.id,e.name,e.date).then(t=>{const s=B(t);return r(s,n.index),t}).catch(t=>(console.error(t),r(n.item,n.index),t)).finally(()=>{i.value=!1,w(e.id,"update")})}async function d(e){const n=p(e.id);return i.value=!0,h(e.id,"delete"),b(e.id),g.deleteShoppingListAsync(e.id).catch(t=>(console.error(t),r(n.item,n.index),t)).finally(()=>{i.value=!1,w(e.id,"delete")})}return j(()=>{M(C?.useAutoListenFor)?.includes("shoppingListsChanges")&&c()}),U(()=>{try{u.value.forEach(e=>{g.unsubscribe(e)})}catch(e){console.error(e)}}),{shoppingLists:F(m),loading:F(T(()=>D.value||i.value)),error:F(T(()=>N.value||v.value)),refresh:R,listenForShoppingListsChanges:c,addShoppingList:_,updateShoppingList:I,deleteShoppingList:d}}const re={class:"card flex justify-center max-w-xl m-auto"},le={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},ce={class:"p-4 grid grid-cols-[80px_1fr]"},de={class:"col-2 justify-self-end"},ue={class:"list-col-grow"},pe=["aria-invalid","placeholder"],he={key:0,class:"validator-hint hidden"},me={class:"btn btn-ghost btn-square"},fe=["onClick"],ge={key:1,class:"list-row"},_e={key:0},Se=z({__name:"index",async setup(C){let o,i;const{shoppingLists:v,loading:u,error:x,addShoppingList:D,deleteShoppingList:N,updateShoppingList:R}=([o,i]=P(()=>ie({useAutoListenFor:["shoppingListsChanges"]})),o=await o,i(),o),m=S(""),p=S("");async function r(h){D({name:p.value||A()}).then(c=>{oe(c),h.currentTarget?.reset(),w()}).catch(c=>{m.value=c.toString()})}async function b(h){N({id:h})}function w(){p.value="",m.value=""}function A(){return new Intl.DateTimeFormat("pl-PL").format(new Date)}return(h,c)=>{const _=K,I=Z;return f(),y("div",re,[a("ul",le,[a("li",ce,[l(u)?(f(),q(_,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):E("",!0),a("span",de,"List: "+L(l(v).length),1)]),a("li",null,[a("form",{class:"list-row",onSubmit:$(r,["prevent"])},[a("label",ue,[J(a("input",{"onUpdate:modelValue":c[0]||(c[0]=d=>H(p)?p.value=d:null),"aria-invalid":!!l(m),class:"input input-ghost validator",placeholder:A(),type:"text"},null,8,pe),[[G,l(p)]]),l(m).trim()?(f(),y("span",he,L(l(m)),1)):E("",!0)]),a("button",me,[k(_,{name:"streamline-freehand:add-sign-bold"})])],32)]),l(v)?.length?(f(!0),y(Q,{key:0},W(l(v),d=>(f(),y("li",{key:d.id,class:"list-row"},[k(I,{to:{name:"lists-id",params:{id:d.id}},class:"list-col-grow"},{default:X(()=>[a("span",null,L(d.name),1)]),_:2},1032,["to"]),a("span",null,[Y(L(d.productAmount)+" ",1),k(_,{name:"streamline-freehand:shopping-cart-trolley"})]),a("button",{onClick:e=>b(d.id)},[k(_,{name:"streamline-freehand:remove-delete-sign-bold"})],8,fe)]))),128)):(f(),y("li",ge,"Brak list"))]),l(x)?(f(),y("div",_e,L(l(x)),1)):E("",!0)])}}});export{Se as default};
