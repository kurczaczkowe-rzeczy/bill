import{e as j,f as M,c as v,o as g,r as B,g as k,F as U,h as z,m as q,i as c,j as E,k as x,l as J,n as G,p as H,q as K,s as $,v as Q,b,w as N,d as V,a as l,t as A,x as W,y as X,z as Y,A as Z,B as ee,C as te}from"./BDdzVwkJ.js";import{_ as ne}from"./DqwnskmJ.js";import{getShoppingListsChannelName as se}from"./D0huSepL.js";import{u as oe,s as y,r as R,a as ae,k as ie,g as re,h as le}from"./BgK8kK6M.js";const ce={class:"list"},de={key:0,class:"list-row"},ue=j({__name:"BaseList",props:{items:{},itemProps:{type:Function}},setup(L){const s=L,a=M();return(d,u)=>(g(),v("ul",ce,[B(d.$slots,"static"),B(d.$slots,"default",{},()=>[s.items?.length?(g(!0),v(U,{key:0},z(s.items,p=>(g(),v("li",q({class:"list-row"},{ref_for:!0},s.itemProps?.(p),{key:p.id}),[B(d.$slots,"item",{item:p})],16))),128)):k("",!0)]),!s.items?.length&&c(a).empty?(g(),v("li",de,[B(d.$slots,"empty")])):k("",!0)]))}}),pe=Object.assign(ue,{__name:"BaseList"});async function me(L){const s=E(()=>se()),a=x(!1),d=x(null),u=x(new Map),{data:p,pending:F,error:I,refresh:O}=oe("shoppingLists",async()=>{const e=await y.getShoppingListsAsync();return R(e)},{getCachedData(e){const n=J(),t=n.payload.data[e]||n.static.data[e];if(!t)return;const o=new Date(t.fetchedAt);if(o.setTime(o.getTime()+300*1e3),new Date<o)return t},server:!1,...L}),{listToSync:_,getItem:m,upsertItem:r,deleteItem:C,releaseAction:S,isActionBlocked:D,blockAction:h}=ae(p);async function i(){u.value.has(s.value)&&u.value.get(s.value)&&y.unsubscribe(u.value.get(s.value));async function e(n){try{const t=ie(n),o=re(t);if(D(t.record?.id??t.oldRecord?.id,o))return;switch(o){case"insert":{r({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date,productAmount:t.record.productAmount},0);break}case"update":r({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date});break;case"delete":C(t.oldRecord.id);break;default:throw new Error("Invalid payload")}}catch(t){console.error(t)}}return u.value.set(s.value,y.listenForShoppingListsChanges(e)),u.value.get(s.value)}async function w(e){if(e.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");a.value=!0;const n=new Date,t=n.valueOf()*2;return h(t,"insert"),r({id:t,createdAt:n.toISOString(),name:e.name,date:new Intl.DateTimeFormat("pl-PL").format(n),productAmount:0},0),y.createShoppingListAsync(e.name).then(o=>{const P=R(o);return r(P,0,!0),o}).catch(o=>(console.error(o),o)).finally(()=>{a.value=!1,S(t,"insert")})}async function T(e){if(e.name?.trim()==="")throw new Error("Nazwa powinna być wypełniona");const n=m(e.id);return a.value=!0,h(e.id,"update"),r({...e},n.index),y.updateShoppingListAsync(e.id,e.name,e.date).then(t=>{const o=R(t);return r(o,n.index),t}).catch(t=>(console.error(t),r(n.item,n.index),t)).finally(()=>{a.value=!1,S(e.id,"update")})}async function f(e){const n=m(e.id);return a.value=!0,h(e.id,"delete"),C(e.id),y.deleteShoppingListAsync(e.id).catch(t=>(console.error(t),r(n.item,n.index),t)).finally(()=>{a.value=!1,S(e.id,"delete")})}return G(()=>{H(L?.useAutoListenFor)?.includes("shoppingListsChanges")&&i()}),K(()=>{try{u.value.forEach(e=>{y.unsubscribe(e)})}catch(e){console.error(e)}}),{shoppingLists:$(_),loading:$(E(()=>F.value||a.value)),error:$(E(()=>I.value||d.value)),refresh:O,listenForShoppingListsChanges:i,addShoppingList:w,updateShoppingList:T,deleteShoppingList:f}}const he={class:"card flex justify-center max-w-xl m-auto"},fe={class:"p-4 grid grid-cols-[80px_1fr]"},ge={class:"col-2 justify-self-end"},_e={class:"list-col-grow"},ye=["aria-invalid","placeholder"],ve={key:0,class:"validator-hint hidden"},we={class:"btn btn-ghost btn-circle"},Le=["onClick"],Se={key:0},Ce=j({__name:"index",async setup(L){let s,a;const{shoppingLists:d,loading:u,error:p,addShoppingList:F,deleteShoppingList:I,updateShoppingList:O}=([s,a]=Q(()=>me({useAutoListenFor:["shoppingListsChanges"]})),s=await s,a(),s),_=x(""),m=x("");async function r(h){F({name:m.value||D()}).then(i=>{le(i),h.currentTarget?.reset(),S()}).catch(i=>{_.value=i.toString()})}async function C(h){I({id:h})}function S(){m.value="",_.value=""}function D(){return new Intl.DateTimeFormat("pl-PL").format(new Date)}return(h,i)=>{const w=W,T=ne;return g(),v("div",he,[b(pe,{class:"card-body bg-base-100 rounded-box shadow-md w-full",items:c(d)},{static:N(()=>[l("li",fe,[c(u)?(g(),X(w,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):k("",!0),l("span",ge,"List: "+A(c(d).length),1)]),l("li",null,[l("form",{class:"list-row",onSubmit:Y(r,["prevent"])},[l("label",_e,[Z(l("input",{"onUpdate:modelValue":i[0]||(i[0]=f=>ee(m)?m.value=f:null),"aria-invalid":!!c(_),class:"input input-ghost validator",placeholder:D(),type:"text"},null,8,ye),[[te,c(m)]]),c(_).trim()?(g(),v("span",ve,A(c(_)),1)):k("",!0)]),l("button",we,[b(w,{name:"streamline-freehand:add-sign-bold"})])],32)])]),item:N(({item:f})=>[b(T,{to:{name:"lists-id",params:{id:f.id}},class:"list-col-grow"},{default:N(()=>[l("span",null,A(f.name),1)]),_:2},1032,["to"]),l("span",null,[V(A(f.productAmount)+" ",1),b(w,{name:"streamline-freehand:shopping-cart-trolley"})]),l("button",{onClick:e=>C(f.id)},[b(w,{name:"streamline-freehand:remove-delete-sign-bold"})],8,Le)]),empty:N(()=>i[1]||(i[1]=[V("Brak list",-1)])),_:1},8,["items"]),c(p)?(g(),v("div",Se,A(c(p)),1)):k("",!0)])}}});export{Ce as default};
