import{B as ve,g as j,r as y,e as ue,i as me,f as X,j as he,k as Y,h as we,l as ye,C as _e,m as oe,D as ae,c as l,a,n as B,b as O,p as be,w as xe,q as n,s as Z,v as W,x as re,d as le,F as P,A as q,E as ke,G as ee,t as m,o as r,z as Ce,H as te}from"./C4lLsOEO.js";import{_ as Ie}from"./BNSO_T1m.js";import{UnitEnum as U,getShoppingListChannelName as Le,groupProductsByCategoryJs as Ae}from"./Bx0rNsYC.js";import{a as Se,u as de,s as T,r as ne,i as M,k as G,c as Ee,p as De}from"./Dp28m5vB.js";async function Te(N,d){const _=ve(N),L=j(()=>ie(X(_))),A=j(()=>Le(X(L))),c=y([]),J=y(!1),K=y(null),x=y(new Map),{data:S}=Se("categories"),{data:V,pending:u,error:F,refresh:p}=de(`shoppingListDetails:${L}`,async()=>{const e=await T.getShoppingListAsync(L.value);return ne(e)},{getCachedData(e){const i=we(),g=i.payload.data[e]||i.static.data[e];if(!g)return;const w=new Date(g.fetchedAt);if(w.setTime(w.getTime()+300*1e3),new Date<w)return g},server:!1,...d});ue(V,e=>{e&&(c.value=e)});function h(e){return c.value?.findIndex(i=>i.id===e)??-1}function E(e,i){if(M(e))throw new Error("Invalid product id");c.value[e].inCart=i??c.value[e]?.inCart}function f(e){if(M(e))throw new Error("Invalid product");const i=h(e.id);if(i===-1){c.value.push(e);return}c.value[i]=e}async function $(){x.value.has(A.value)&&x.value.get(A.value)&&T.unsubscribe(x.value.get(A.value));async function e(i){const g=G(i),w=h(g.record?.id);if(w===-1||M(w)){if(M(g.oldRecord)&&!M(g.record)){const H=T.getShoppingListProductAsync(g.record.id);if(!S.value)throw new Error("Categories not found");const R=S.value?.find(D=>D.id===g.record?.categoryId)??S.value?.[0];if(!R)throw new Error("Category not found");f({id:g.record.id,createdAt:new Date().toISOString(),quantity:g.record.quantity,unit:U.GRAM.name,name:"Produkt",inCart:g.record.inCart,category:R});try{const D=await H,C=ne(D),b=h(C.id);if(b===-1||b===void 0)throw new Error("Product not found");c.value[b]=C}catch(D){console.error(D)}}return}E(w,g.record?.inCart)}return x.value.set(A.value,T.listenForShoppingListChanges(L.value,e)),x.value.get(A.value)}async function z(e){if(!c.value)throw new Error("Shopping list not found");const i=h(e);if(i===-1||M(c.value[i]))throw new Error("Product not found");const g={...c.value[i]};E(i,c.value[i].inCart),T.toggleProductInCartAsync(e).then(ne).catch(w=>{f(g),console.error(w)})}async function k(e){if(e.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");return T.addToShoppingListAsync(ie(e.listId),U.valueOf(e.unit.name),e.quantity,e.name,e.categoryId)}return me(()=>{X(d?.useAutoListenFor)?.includes("shoppingListChanges")&&$()}),he(()=>{try{x.value.forEach(e=>{T.unsubscribe(e)})}catch(e){console.error(e)}}),{shoppingListDetails:Y(c),loading:Y(j(()=>u.value||J.value)),error:Y(j(()=>F.value||K.value)),refresh:p,listenForShoppingListChanges:$,toggleInCart:z,addToShoppingList:k,categoriesWithProducts:j(()=>c.value&&S.value?G(Ae(c.value,S.value)):[])}}function ie(N){const d=Array.isArray(N)?N[0]:N;if(d==null)throw new Error(`Invalid list ID. It should be a string or number. Actual value: ${d}`);const _=parseInt(d,10);if(Number.isNaN(_))throw new Error(`Invalid list ID. Is not a number. Actual value: ${d}`);return _}const Ne={class:"card flex justify-center flex-col max-w-xl m-auto"},$e={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},Be={class:"px-2 inline-flex flex-row gap-2"},Pe={class:"list-row-separator"},qe={class:"btn btn-ghost btn-square"},Me={class:"relative col-span-2"},je=["aria-expanded","aria-activedescendant"],ze={key:0,id:"suggestions-list",class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 menu bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Ue={key:0,class:"disabled",role:"presentation"},Ve=["id","aria-selected","onClick","onMouseenter"],Fe={class:"badge badge-ghost badge-sm"},Re={key:2,class:"disabled",role:"presentation"},Oe=["value"],Ge={class:"relative col-span-3"},Je={key:0,class:"flex items-center gap-2"},Ke={key:1,class:"opacity-60"},He={key:0,class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Qe={key:0,class:"disabled",role:"presentation"},Xe=["aria-selected","onClick"],Ye={class:"inline-flex items-center gap-2"},Ze={class:"list"},We=["onClick"],et={class:"list-col-grow"},tt={key:1,class:"list-row"},nt={key:1,class:"list-row"},st={key:0,class:"flex flex-col gap-1"},ot={class:"text-error"},ut=ye({__name:"[id]",async setup(N){let d,_;const L=_e(),A=U.values(),{categoriesWithProducts:c,error:J,loading:K,toggleInCart:x,addToShoppingList:S}=([d,_]=oe(()=>Te(L.params.id,{useAutoListenFor:["shoppingListChanges"]})),d=await d,_(),d),V=ae({name:""}),u=ae({name:"",quantity:1,unit:U.GRAM,categoryId:1}),F=j(()=>[J.value,R.value].filter(Boolean)),p=y([]),h=y(!1),E=y(!1),f=y(-1);let $=null;function z(){p.value.length>0&&(h.value=!0)}function k(){h.value=!1,f.value=-1}function e(s){u.name=s.name,u.unit=U.valueOf(s.unit),k()}async function i(s){if(!s||s.trim().length<2){p.value=[],k();return}E.value=!0;try{const o=await De.getProductSuggestionAsync(u.name);if("error"in o){p.value=[],k();return}if(!("result"in o)){p.value=[],k();return}const I=G(o.result);p.value=I||[],z()}finally{E.value=!1}}ue(()=>u.name,s=>{$&&clearTimeout($),$=setTimeout(()=>{i(s)},250)});function g(s){if(!h.value&&(s.key==="ArrowDown"||s.key==="ArrowUp")){z();return}h.value&&(s.key==="ArrowDown"?(s.preventDefault(),f.value=p.value.length===0?-1:(f.value+1)%p.value.length):s.key==="ArrowUp"?(s.preventDefault(),f.value=p.value.length===0?-1:(f.value-1+p.value.length)%p.value.length):s.key==="Enter"?f.value>=0&&f.value<p.value.length&&(s.preventDefault(),e(p.value[f.value])):s.key==="Escape"&&k())}function w(){setTimeout(()=>k(),100)}const{data:H,error:R,status:D}=([d,_]=oe(async()=>de("categories",async()=>{const s=await Ee.getCategoriesAsync();if("error"in s)throw new Error(s);if(!("result"in s))throw new Error("Unsupported response type: "+s.constructor.name);return G(s.result)},{server:!1})),d=await d,_(),d),C=y(null),b=y(!1),Q=s=>{if(!s)return"";const o=s.split(" ");return o.length>1?o.slice(0,2).map(I=>I[0]).join("").toUpperCase():s.slice(0,2).toUpperCase()},ce=s=>{C.value=s,b.value=!1,u.categoryId=s.id};async function pe(s){S({listId:L.params.id,...u}).then(()=>{s.currentTarget?.reset(),ge()}).catch(o=>{V.name=o.message})}function ge(){u.name="",u.quantity=1,V.name=""}return(s,o)=>{const I=Ce,fe=Ie;return r(),l("div",Ne,[a("ul",$e,[a("li",Be,[O(fe,{to:"/"},{default:xe(()=>[O(I,{name:"streamline-freehand:keyboard-arrow-return"})]),_:1}),n(K)?(r(),be(I,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):B("",!0)]),a("li",Pe,[a("form",{class:"grid grid-cols-[80px_minmax(0,_auto)_45px]",onSubmit:Z(pe,["prevent"])},[a("button",qe,[O(I,{name:"streamline-freehand:add-sign-bold"})]),a("div",Me,[W(a("input",{"onUpdate:modelValue":o[0]||(o[0]=t=>n(u).name=t),class:"input input-ghost w-full",placeholder:"Nazwa produktu",required:"",type:"text",autocomplete:"off",role:"combobox","aria-autocomplete":"list","aria-expanded":n(h),"aria-controls":"suggestions-list","aria-activedescendant":n(f)>=0?`suggestion-${n(f)}`:void 0,onFocus:o[1]||(o[1]=t=>z()),onBlur:w,onKeydown:g},null,40,je),[[re,n(u).name]]),n(h)?(r(),l("ul",ze,[n(E)?(r(),l("li",Ue,o[8]||(o[8]=[a("span",{class:"loading loading-spinner loading-sm"},null,-1),le(" Ładowanie… ",-1)]))):n(p).length>0?(r(!0),l(P,{key:1},q(n(p),(t,v)=>(r(),l("li",{id:`suggestion-${v}`,key:t.id||t.name+v,role:"option",class:te(["inline-flex flex-row justify-between items-center",{active:v===n(f)}]),"aria-selected":v===n(f),onClick:se=>e(t),onMouseenter:se=>f.value=v,onMousedown:o[2]||(o[2]=Z(()=>{},["prevent"]))},[a("span",null,m(t.name),1),a("span",Fe,m(t.unit||"szt."),1)],42,Ve))),128)):!n(E)&&n(p).length===0?(r(),l("li",Re,o[9]||(o[9]=[a("span",{class:"opacity-60"},"Brak sugestii",-1)]))):B("",!0)])):B("",!0)]),W(a("input",{"onUpdate:modelValue":o[3]||(o[3]=t=>n(u).quantity=t),class:"input input-ghost",min:"1",required:"",type:"number"},null,512),[[re,n(u).quantity]]),W(a("select",{"onUpdate:modelValue":o[4]||(o[4]=t=>n(u).unit=t),class:"select select-ghost col-span-2 w-full"},[o[10]||(o[10]=a("option",{disabled:"",selected:""},"Wybierz jednostkę",-1)),(r(!0),l(P,null,q(n(A),t=>(r(),l("option",{key:t.name,value:t},m(t.name),9,Oe))),128))],512),[[ke,n(u).unit]]),a("div",Ge,[a("button",{type:"button",class:"btn btn-ghost w-full justify-between",onClick:o[5]||(o[5]=t=>b.value=!n(b)),onBlur:o[6]||(o[6]=t=>b.value=!1)},[n(C)?(r(),l("div",Je,[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:ee({backgroundColor:`#${n(C).color}`})},m(Q(n(C).name)),5),a("span",null,m(n(C).name),1)])):(r(),l("span",Ke,"Wybierz kategorię")),O(I,{name:"mdi:chevron-down",class:"ml-auto"})],32),n(b)?(r(),l("ul",He,[n(D)==="pending"?(r(),l("li",Qe,o[11]||(o[11]=[a("span",{class:"loading loading-spinner loading-sm"},null,-1),le(" Ładowanie… ",-1)]))):B("",!0),(r(!0),l(P,null,q(n(H),t=>(r(),l("li",{key:t.id,role:"option",class:te([{active:n(u).categoryId===t.id},"inline-flex flex-row w-full items-center gap-3 px-3 py-2 rounded-lg cursor-pointer hover:bg-base-200"]),"aria-selected":n(u).categoryId===t.id,onMousedown:o[7]||(o[7]=Z(()=>{},["prevent"])),onClick:v=>ce(t)},[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:ee({backgroundColor:`#${t.color}`})},m(Q(t.name)),5),a("span",null,m(t.name),1)],42,Xe))),128))])):B("",!0)])],32)]),n(c).length?(r(!0),l(P,{key:0},q(n(c),t=>(r(),l("li",{key:t.category.id,class:"category-list"},[a("span",Ye,[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:ee({backgroundColor:`#${t.category.color}`})},m(Q(t.category.name)),5),a("span",null,m(t.category.name),1)]),a("ul",Ze,[t.products?.length?(r(!0),l(P,{key:0},q(t.products,v=>(r(),l("li",{key:v.id,class:te([{"line-through":v.inCart},"list-row"]),onClick:se=>n(x)(v.id)},[a("span",et,m(v.name),1),a("span",null,m(v.quantity)+" "+m(v.unit),1)],10,We))),128)):(r(),l("li",tt,"Brak produktów w kategorii"))])]))),128)):(r(),l("li",nt,"Brak produktów na liście"))]),n(F).length?(r(),l("div",st,[(r(!0),l(P,null,q(n(F),t=>(r(),l("span",ot,m(t),1))),256))])):B("",!0)])}}});export{ut as default};
