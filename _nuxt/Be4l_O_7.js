import me from"./C1jEFe-5.js";import{_ as he}from"./BYN4OAKp.js";import{m as ve,n as q,r as _,p as ue,q as we,s as X,x as ye,y as Y,z as _e,e as be,A as xe,f as oe,B as ae,c as i,a,g as $,b as G,C as ke,w as Ce,j as n,h as Z,i as W,v as re,d as ie,F as P,l as B,D as Ie,E as ee,t as v,o as r,G as te}from"./dWzZzfi_.js";import{S as Le,P as Se,C as Ae,U as z,g as Ee,a as De}from"./BVKMfozv.js";import{k as R,a as Te,u as de}from"./CwhWHFHu.js";const j=new Le,Ne=new Se,$e=new Ae,U=l=>l==null;function Pe(l){if("error"in l)throw new Error(l)}function Be(l){if(!("result"in l))throw new Error("Unsupported response type: "+l.constructor.name);return R(l.result)}function ne(l){return Pe(l),Be(l)}async function Ue(l,c){const b=ve(l),L=q(()=>le(X(b))),T=q(()=>Ee(X(L))),p=_([]),J=_(!1),K=_(null),S=_(new Map),{data:A}=Te("categories"),{data:V,pending:d,error:F,refresh:g}=de(`shoppingListDetails:${L}`,async()=>{const e=await j.getShoppingListAsync(L.value);return ne(e)},{getCachedData(e){const u=_e(),f=u.payload.data[e]||u.static.data[e];if(!f)return;const y=new Date(f.fetchedAt);if(y.setTime(y.getTime()+300*1e3),new Date<y)return f},server:!1,...c});ue(V,e=>{e&&(p.value=e)});function w(e){return p.value?.findIndex(u=>u.id===e)??-1}function E(e,u){if(U(e))throw new Error("Invalid product id");p.value[e].inCart=u??p.value[e]?.inCart}function m(e){if(U(e))throw new Error("Invalid product");const u=w(e.id);if(u===-1){p.value.push(e);return}p.value[u]=e}function N(){S.value.has(T.value)&&S.value.get(T.value)?.unsubscribe();async function e(u){const f=R(u),y=w(f.record?.id);if(y===-1||U(y)){if(U(f.oldRecord)&&!U(f.record)){const H=j.getShoppingListProductAsync(f.record.id);if(!A.value)throw new Error("Categories not found");const O=A.value?.find(D=>D.id===f.record?.categoryId)??A.value?.[0];if(!O)throw new Error("Category not found");m({id:f.record.id,createdAt:new Date().toISOString(),quantity:f.record.quantity,unit:z.GRAM.name,name:"Produkt",inCart:f.record.inCart,category:O});try{const D=await H,C=ne(D),x=w(C.id);if(x===-1||x===void 0)throw new Error("Product not found");p.value[x]=C}catch(D){console.error(D)}}return}E(y,f.record?.inCart)}return S.value.set(T.value,j.listenForShoppingListChanges(L.value,e)),S.value.get(T.value)}async function M(e){if(!p.value)throw new Error("Shopping list not found");const u=w(e);if(u===-1||U(p.value[u]))throw new Error("Product not found");const f={...p.value[u]};E(u,p.value[u].inCart),j.toggleProductInCartAsync(e).then(ne).catch(y=>{m(f),console.error(y)})}async function k(e){if(e.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");return j.addToShoppingListAsync(le(e.listId),z.valueOf(e.unit.name),e.quantity,e.name,e.categoryId)}return we(()=>{X(c?.useAutoListenFor)?.includes("shoppingListChanges")&&N()}),ye(()=>{S.value.forEach(e=>{e.unsubscribe()})}),{shoppingListDetails:Y(p),loading:Y(q(()=>d.value||J.value)),error:Y(q(()=>F.value||K.value)),refresh:g,listenForShoppingListChanges:N,toggleInCart:M,addToShoppingList:k,categoriesWithProducts:q(()=>p.value&&A.value?R(De(p.value,A.value)):[])}}function le(l){const c=Array.isArray(l)?l[0]:l;if(c==null)throw new Error(`Invalid list ID. It should be a string or number. Actual value: ${c}`);const b=parseInt(c,10);if(Number.isNaN(b))throw new Error(`Invalid list ID. Is not a number. Actual value: ${c}`);return b}const qe={class:"card flex justify-center flex-col max-w-xl m-auto"},Me={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},je={class:"px-2 inline-flex flex-row gap-2"},ze={class:"list-row-separator"},Re={class:"btn btn-ghost btn-square"},Ve={class:"relative col-span-2"},Fe=["aria-expanded","aria-activedescendant"],Oe={key:0,id:"suggestions-list",class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 menu bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Ge={key:0,class:"disabled",role:"presentation"},Je=["id","aria-selected","onClick","onMouseenter"],Ke={class:"badge badge-ghost badge-sm"},He={key:2,class:"disabled",role:"presentation"},Qe=["value"],Xe={class:"relative col-span-3"},Ye={key:0,class:"flex items-center gap-2"},Ze={key:1,class:"opacity-60"},We={key:0,class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},et={key:0,class:"disabled",role:"presentation"},tt=["aria-selected","onClick"],nt={class:"inline-flex items-center gap-2"},st={class:"list"},ot=["onClick"],at={class:"list-col-grow"},rt={key:1,class:"list-row"},it={key:1,class:"list-row"},lt={key:0,class:"flex flex-col gap-1"},ut={class:"text-error"},mt=be({__name:"[id]",async setup(l){let c,b;const L=xe(),T=z.values(),{categoriesWithProducts:p,error:J,loading:K,toggleInCart:S,addToShoppingList:A}=([c,b]=oe(()=>Ue(L.params.id,{useAutoListenFor:["shoppingListChanges"]})),c=await c,b(),c),V=ae({name:""}),d=ae({name:"",quantity:1,unit:z.GRAM,categoryId:1}),F=q(()=>[J.value,O.value].filter(Boolean)),g=_([]),w=_(!1),E=_(!1),m=_(-1);let N=null;function M(){g.value.length>0&&(w.value=!0)}function k(){w.value=!1,m.value=-1}function e(s){d.name=s.name,d.unit=z.valueOf(s.unit),k()}async function u(s){if(!s||s.trim().length<2){g.value=[],k();return}E.value=!0;try{const o=await Ne.getProductSuggestionAsync(d.name);if("error"in o){g.value=[],k();return}if(!("result"in o)){g.value=[],k();return}const I=R(o.result);g.value=I||[],M()}finally{E.value=!1}}ue(()=>d.name,s=>{N&&clearTimeout(N),N=setTimeout(()=>{u(s)},250)});function f(s){if(!w.value&&(s.key==="ArrowDown"||s.key==="ArrowUp")){M();return}w.value&&(s.key==="ArrowDown"?(s.preventDefault(),m.value=g.value.length===0?-1:(m.value+1)%g.value.length):s.key==="ArrowUp"?(s.preventDefault(),m.value=g.value.length===0?-1:(m.value-1+g.value.length)%g.value.length):s.key==="Enter"?m.value>=0&&m.value<g.value.length&&(s.preventDefault(),e(g.value[m.value])):s.key==="Escape"&&k())}function y(){setTimeout(()=>k(),100)}const{data:H,error:O,status:D}=([c,b]=oe(async()=>de("categories",async()=>{const s=await $e.getCategoriesAsync();if("error"in s)throw new Error(s);if(!("result"in s))throw new Error("Unsupported response type: "+s.constructor.name);return R(s.result)},{server:!1})),c=await c,b(),c),C=_(null),x=_(!1),Q=s=>{if(!s)return"";const o=s.split(" ");return o.length>1?o.slice(0,2).map(I=>I[0]).join("").toUpperCase():s.slice(0,2).toUpperCase()},ce=s=>{C.value=s,x.value=!1,d.categoryId=s.id};async function pe(s){A({listId:L.params.id,...d}).then(()=>{s.currentTarget?.reset(),ge()}).catch(o=>{V.name=o.message})}function ge(){d.name="",d.quantity=1,V.name=""}return(s,o)=>{const I=me,fe=he;return r(),i("div",qe,[a("ul",Me,[a("li",je,[G(fe,{to:"/"},{default:Ce(()=>[G(I,{name:"streamline-freehand:keyboard-arrow-return"})]),_:1}),n(K)?(r(),ke(I,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):$("",!0)]),a("li",ze,[a("form",{class:"grid grid-cols-[80px_minmax(0,_auto)_45px]",onSubmit:Z(pe,["prevent"])},[a("button",Re,[G(I,{name:"streamline-freehand:add-sign-bold"})]),a("div",Ve,[W(a("input",{"onUpdate:modelValue":o[0]||(o[0]=t=>n(d).name=t),class:"input input-ghost w-full",placeholder:"Nazwa produktu",required:"",type:"text",autocomplete:"off",role:"combobox","aria-autocomplete":"list","aria-expanded":n(w),"aria-controls":"suggestions-list","aria-activedescendant":n(m)>=0?`suggestion-${n(m)}`:void 0,onFocus:o[1]||(o[1]=t=>M()),onBlur:y,onKeydown:f},null,40,Fe),[[re,n(d).name]]),n(w)?(r(),i("ul",Oe,[n(E)?(r(),i("li",Ge,o[8]||(o[8]=[a("span",{class:"loading loading-spinner loading-sm"},null,-1),ie(" Ładowanie… ",-1)]))):n(g).length>0?(r(!0),i(P,{key:1},B(n(g),(t,h)=>(r(),i("li",{id:`suggestion-${h}`,key:t.id||t.name+h,role:"option",class:te(["inline-flex flex-row justify-between items-center",{active:h===n(m)}]),"aria-selected":h===n(m),onClick:se=>e(t),onMouseenter:se=>m.value=h,onMousedown:o[2]||(o[2]=Z(()=>{},["prevent"]))},[a("span",null,v(t.name),1),a("span",Ke,v(t.unit||"szt."),1)],42,Je))),128)):!n(E)&&n(g).length===0?(r(),i("li",He,o[9]||(o[9]=[a("span",{class:"opacity-60"},"Brak sugestii",-1)]))):$("",!0)])):$("",!0)]),W(a("input",{"onUpdate:modelValue":o[3]||(o[3]=t=>n(d).quantity=t),class:"input input-ghost",min:"1",required:"",type:"number"},null,512),[[re,n(d).quantity]]),W(a("select",{"onUpdate:modelValue":o[4]||(o[4]=t=>n(d).unit=t),class:"select select-ghost col-span-2 w-full"},[o[10]||(o[10]=a("option",{disabled:"",selected:""},"Wybierz jednostkę",-1)),(r(!0),i(P,null,B(n(T),t=>(r(),i("option",{key:t.name,value:t},v(t.name),9,Qe))),128))],512),[[Ie,n(d).unit]]),a("div",Xe,[a("button",{type:"button",class:"btn btn-ghost w-full justify-between",onClick:o[5]||(o[5]=t=>x.value=!n(x)),onBlur:o[6]||(o[6]=t=>x.value=!1)},[n(C)?(r(),i("div",Ye,[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:ee({backgroundColor:`#${n(C).color}`})},v(Q(n(C).name)),5),a("span",null,v(n(C).name),1)])):(r(),i("span",Ze,"Wybierz kategorię")),G(I,{name:"mdi:chevron-down",class:"ml-auto"})],32),n(x)?(r(),i("ul",We,[n(D)==="pending"?(r(),i("li",et,o[11]||(o[11]=[a("span",{class:"loading loading-spinner loading-sm"},null,-1),ie(" Ładowanie… ",-1)]))):$("",!0),(r(!0),i(P,null,B(n(H),t=>(r(),i("li",{key:t.id,role:"option",class:te([{active:n(d).categoryId===t.id},"inline-flex flex-row w-full items-center gap-3 px-3 py-2 rounded-lg cursor-pointer hover:bg-base-200"]),"aria-selected":n(d).categoryId===t.id,onMousedown:o[7]||(o[7]=Z(()=>{},["prevent"])),onClick:h=>ce(t)},[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:ee({backgroundColor:`#${t.color}`})},v(Q(t.name)),5),a("span",null,v(t.name),1)],42,tt))),128))])):$("",!0)])],32)]),n(p).length?(r(!0),i(P,{key:0},B(n(p),t=>(r(),i("li",{key:t.category.id,class:"category-list"},[a("span",nt,[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:ee({backgroundColor:`#${t.category.color}`})},v(Q(t.category.name)),5),a("span",null,v(t.category.name),1)]),a("ul",st,[t.products?.length?(r(!0),i(P,{key:0},B(t.products,h=>(r(),i("li",{key:h.id,class:te([{"line-through":h.inCart},"list-row"]),onClick:se=>n(S)(h.id)},[a("span",at,v(h.name),1),a("span",null,v(h.quantity)+" "+v(h.unit),1)],10,ot))),128)):(r(),i("li",rt,"Brak produktów w kategorii"))])]))),128)):(r(),i("li",it,"Brak produktów na liście"))]),n(F).length?(r(),i("div",lt,[(r(!0),i(P,null,B(n(F),t=>(r(),i("span",ut,v(t),1))),256))])):$("",!0)])}}});export{mt as default};
