import{A as ve,e as z,r as C,g as ye,h as se,i as we,j as oe,f as be,k as _e,B as ke,l as ue,C as ce,D as xe,c as i,a as r,m as M,b as G,n as Ce,w as Ie,p as s,q as Q,s as ae,v as de,d as pe,F as U,z as j,E as Le,G as re,t as m,o as l,y as Ae,H as le}from"./BQU3Vh94.js";import{_ as Se}from"./DOmJWwF4.js";import{groupProductsByCategoryJs as De,UnitEnum as J,getShoppingListChannelName as Ee}from"./D3ioxxVQ.js";import{b as Te,u as fe,s as x,r as B,a as Pe,k as X,g as $e,c as Be,p as Ne}from"./BBIHsEx9.js";async function qe(N,p){const I=ve(N),A=z(()=>ge(se(I))),E=z(()=>Ee(se(A))),h=C(!1),Y=C(null),S=C(new Map),{data:k}=Te("categories"),{data:Z,pending:W,error:ie,refresh:K}=fe(`shoppingListDetails:${A.value}`,async()=>{const o=await x.getShoppingListAsync(A.value);return B(o)},{getCachedData(o){const u=be(),a=u.payload.data[o]||u.static.data[o];if(!a)return;const v=new Date(a.fetchedAt);if(v.setTime(v.getTime()+300*1e3),new Date<v)return a},server:!1,...p}),{listToSync:T,getItem:c,upsertItem:b,deleteItem:g,releaseAction:_,isActionBlocked:q,blockAction:d}=Pe(Z),R=z(()=>T.value&&k.value?X(De(T.value,k.value)):[]);async function F(){S.value.has(E.value)&&S.value.get(E.value)&&x.unsubscribe(S.value.get(E.value));async function o(u){try{const a=X(u),v=$e(a);if(q(a.record?.id??a.oldRecord?.id,v))return;switch(v){case"insert":{const y=x.getShoppingListProductAsync(a.record.id);if(!k.value)throw new Error("Categories not found");const w=k.value?.find(O=>O.id===a.record?.categoryId)??k.value?.[0];if(!w)throw new Error("Category not found");b({id:a.record.id,createdAt:new Date().toISOString(),quantity:a.record.quantity,unit:J.GRAM.name,name:"Ładowanie...",inCart:a.record.inCart,category:w});const $=await y,V=B($);b(V);break}case"update":{const y=x.getShoppingListProductAsync(a.record.id);if(!k.value)throw new Error("Categories not found");if(!(k.value?.find(O=>O.id===a.record?.categoryId)??k.value?.[0]))throw new Error("Category not found");b(a.record);const $=await y,V=B($);b(V);break}case"delete":g(a.oldRecord.id);break;default:throw new Error("Invalid payload")}}catch(a){console.error(a)}}return S.value.set(E.value,x.listenForShoppingListChanges(A.value,o)),S.value.get(E.value)}async function D(o){if(!T.value)throw new Error("Shopping list not found");const u=c(o);if(!u.item)throw new Error("Product not found");h.value=!0,d(o,"update"),b({id:u.item.id,inCart:u.item.inCart},u.index,!0),x.toggleProductInCartAsync(o).then(a=>{const v=B(a);b(v,u.index,!0)}).catch(a=>{b(u.item,u.index,!0),console.error(a)}).finally(()=>{h.value=!1,_(o,"update")})}async function H(o,u,a,v){if(o.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");h.value=!0;const y=new Date().valueOf()*2;d(y,"insert"),x.addToShoppingListAsync(ge(o.listId),J.valueOf(o.unit.name),o.quantity,o.name,o.categoryId).then(w=>{const $=B(w);u?.($)}).catch(w=>{console.error(w),a?.(w)}).finally(()=>{h.value=!1,_(y,"insert"),v?.()})}async function ee(o){h.value=!0,d(o,"delete"),x.deleteFromShoppingListAsync(o).then(B).catch(u=>{console.error(u)}).finally(()=>{h.value=!1,_(o,"delete")})}async function te(o,u){h.value=!0,d(o,"update"),b({id:o,category:u}),x.updateInShoppingListAsync(o,A.value,null,null,null,u.id).then(a=>{B(a)}).catch(a=>{console.error(a)}).finally(()=>{h.value=!1,_(o,"update")})}return ye(()=>{se(p?.useAutoListenFor)?.includes("shoppingListChanges")&&F()}),we(()=>{try{S.value.forEach(o=>{x.unsubscribe(o)})}catch(o){console.error(o)}}),{shoppingListDetails:oe(T),loading:oe(z(()=>W.value||h.value)),error:oe(z(()=>ie.value||Y.value)),refresh:K,listenForShoppingListChanges:F,toggleInCart:D,addToShoppingList:H,switchProductCategory:te,deleteProductFromShoppingList:ee,categoriesWithProducts:R}}function ge(N){const p=Array.isArray(N)?N[0]:N;if(p==null)throw new Error(`Invalid list ID. It should be a string or number. Actual value: ${p}`);const I=parseInt(p,10);if(Number.isNaN(I))throw new Error(`Invalid list ID. Is not a number. Actual value: ${p}`);return I}const Fe={class:"card flex justify-center flex-col max-w-xl m-auto"},Me={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},Ue={class:"px-2 inline-flex flex-row gap-2"},je={class:"list-row-separator"},ze={class:"btn btn-ghost btn-square"},Re={class:"relative col-span-2"},Ve=["aria-expanded","aria-activedescendant"],Oe={key:0,id:"suggestions-list",class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 menu bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Ge={key:0,class:"disabled",role:"presentation"},Je=["id","aria-selected","onClick","onMouseenter"],Ke={class:"badge badge-ghost badge-sm"},He={key:2,class:"disabled",role:"presentation"},Qe=["value"],Xe={class:"relative col-span-3"},Ye={key:0,class:"flex items-center gap-2"},Ze={key:1,class:"opacity-60"},We={key:0,class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},et={key:0,class:"disabled",role:"presentation"},tt=["aria-selected","onClick"],nt={class:"inline-flex items-center gap-2"},st={class:"list"},ot=["onClick"],at={class:"list-col-grow"},rt=["onClick"],lt={key:1,class:"list-row"},it={key:1,class:"list-row"},ut={key:0,class:"flex flex-col gap-1"},ct={class:"text-error"},mt=_e({__name:"[id]",async setup(N){let p,I;const A=ke(),E=J.values(),{categoriesWithProducts:h,error:Y,loading:S,toggleInCart:k,addToShoppingList:Z,deleteProductFromShoppingList:W,switchProductCategory:ie}=([p,I]=ue(()=>qe(A.params.id,{useAutoListenFor:["shoppingListChanges"]})),p=await p,I(),p),K=C(null),T=ce({name:""}),c=ce({name:"",quantity:1,unit:J.GRAM,categoryId:1}),b=z(()=>[Y.value,a.value].filter(Boolean)),g=C([]),_=C(!1),q=C(!1),d=C(-1);let R=null;function F(){g.value.length>0&&(_.value=!0)}function D(){_.value=!1,d.value=-1}function H(e){try{c.name=e.name,c.unit=J.valueOf(e.unit),D()}catch(t){console.error("selectSuggestion->",t)}}async function ee(e){if(!e||e.trim().length<2){g.value=[],D();return}q.value=!0;try{const t=await Ne.getProductSuggestionAsync(c.name);if("error"in t){g.value=[],D();return}if(!("result"in t)){g.value=[],D();return}const L=X(t.result);g.value=L||[],F()}finally{q.value=!1}}xe(()=>c.name,e=>{R&&clearTimeout(R),R=setTimeout(()=>{ee(e)},250)});function te(e){if(!_.value&&(e.key==="ArrowDown"||e.key==="ArrowUp")){F();return}_.value&&(e.key==="ArrowDown"?(e.preventDefault(),d.value=g.value.length===0?-1:(d.value+1)%g.value.length):e.key==="ArrowUp"?(e.preventDefault(),d.value=g.value.length===0?-1:(d.value-1+g.value.length)%g.value.length):e.key==="Enter"?d.value>=0&&d.value<g.value.length&&(e.preventDefault(),H(g.value[d.value])):e.key==="Escape"&&D())}function o(){setTimeout(()=>D(),100)}const{data:u,error:a,status:v}=([p,I]=ue(async()=>fe("categories",async()=>{const e=await Be.getCategoriesAsync();if("error"in e)throw new Error(e);if(!("result"in e))throw new Error("Unsupported response type: "+e.constructor.name);return X(e.result)},{server:!1})),p=await p,I(),p),P=C(null),y=C(!1),w=e=>{if(!e)return"";const t=e.split(" ");return t.length>1?t.slice(0,2).map(L=>L[0]).join("").toUpperCase():e.slice(0,2).toUpperCase()},$=e=>{P.value=e,y.value=!1,c.categoryId=e.id};async function V(e){Z({listId:A.params.id,...c},()=>{e.currentTarget?.reset(),O()},t=>{T.name=t.message})}function O(){c.name="",c.quantity=1,T.name=""}function me(e){K.value&&Date.now()-K.value>150||k(e)}return(e,t)=>{const L=Ae,he=Se;return l(),i("div",Fe,[r("ul",Me,[r("li",Ue,[G(he,{to:"/"},{default:Ie(()=>[G(L,{name:"streamline-freehand:keyboard-arrow-return"})]),_:1}),s(S)?(l(),Ce(L,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):M("",!0)]),r("li",je,[r("form",{class:"grid grid-cols-[80px_minmax(0,_auto)_45px]",onSubmit:Q(V,["prevent"])},[r("button",ze,[G(L,{name:"streamline-freehand:add-sign-bold"})]),r("div",Re,[ae(r("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>s(c).name=n),class:"input input-ghost w-full",placeholder:"Nazwa produktu",required:"",type:"text",autocomplete:"off",role:"combobox","aria-autocomplete":"list","aria-expanded":s(_),"aria-controls":"suggestions-list","aria-activedescendant":s(d)>=0?`suggestion-${s(d)}`:void 0,onFocus:t[1]||(t[1]=n=>F()),onBlur:o,onKeydown:te},null,40,Ve),[[de,s(c).name]]),s(_)?(l(),i("ul",Oe,[s(q)?(l(),i("li",Ge,t[8]||(t[8]=[r("span",{class:"loading loading-spinner loading-sm"},null,-1),pe(" Ładowanie… ",-1)]))):s(g).length>0?(l(!0),i(U,{key:1},j(s(g),(n,f)=>(l(),i("li",{id:`suggestion-${f}`,key:n.id||n.name+f,role:"option",class:le(["inline-flex flex-row justify-between items-center",{active:f===s(d)}]),"aria-selected":f===s(d),onClick:ne=>H(n),onMouseenter:ne=>d.value=f,onMousedown:t[2]||(t[2]=Q(()=>{},["prevent"]))},[r("span",null,m(n.name),1),r("span",Ke,m(n.unit||"szt."),1)],42,Je))),128)):!s(q)&&s(g).length===0?(l(),i("li",He,t[9]||(t[9]=[r("span",{class:"opacity-60"},"Brak sugestii",-1)]))):M("",!0)])):M("",!0)]),ae(r("input",{"onUpdate:modelValue":t[3]||(t[3]=n=>s(c).quantity=n),class:"input input-ghost",min:"1",required:"",type:"number"},null,512),[[de,s(c).quantity]]),ae(r("select",{"onUpdate:modelValue":t[4]||(t[4]=n=>s(c).unit=n),class:"select select-ghost col-span-2 w-full"},[t[10]||(t[10]=r("option",{disabled:"",selected:""},"Wybierz jednostkę",-1)),(l(!0),i(U,null,j(s(E),n=>(l(),i("option",{key:n.name,value:n},m(n.name),9,Qe))),128))],512),[[Le,s(c).unit]]),r("div",Xe,[r("button",{type:"button",class:"btn btn-ghost w-full justify-between",onClick:t[5]||(t[5]=n=>y.value=!s(y)),onBlur:t[6]||(t[6]=n=>y.value=!1)},[s(P)?(l(),i("div",Ye,[r("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:re({backgroundColor:`#${s(P).color}`})},m(w(s(P).name)),5),r("span",null,m(s(P).name),1)])):(l(),i("span",Ze,"Wybierz kategorię")),G(L,{name:"mdi:chevron-down",class:"ml-auto"})],32),s(y)?(l(),i("ul",We,[s(v)==="pending"?(l(),i("li",et,t[11]||(t[11]=[r("span",{class:"loading loading-spinner loading-sm"},null,-1),pe(" Ładowanie… ",-1)]))):M("",!0),(l(!0),i(U,null,j(s(u),n=>(l(),i("li",{key:n.id,role:"option",class:le([{active:s(c).categoryId===n.id},"inline-flex flex-row w-full items-center gap-3 px-3 py-2 rounded-lg cursor-pointer hover:bg-base-200"]),"aria-selected":s(c).categoryId===n.id,onMousedown:t[7]||(t[7]=Q(()=>{},["prevent"])),onClick:f=>$(n)},[r("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:re({backgroundColor:`#${n.color}`})},m(w(n.name)),5),r("span",null,m(n.name),1)],42,tt))),128))])):M("",!0)])],32)]),s(h).length?(l(!0),i(U,{key:0},j(s(h),n=>(l(),i("li",{key:n.category.id,class:"category-list"},[r("span",nt,[r("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:re({backgroundColor:`#${n.category.color}`})},m(w(n.category.name)),5),r("span",null,m(n.category.name),1)]),r("ul",st,[n.products?.length?(l(!0),i(U,{key:0},j(n.products,f=>(l(),i("li",{key:f.id,class:le([{"line-through":f.inCart},"list-row"]),onClick:ne=>me(f.id)},[r("span",at,m(f.name),1),r("span",null,m(f.quantity)+" "+m(f.unit),1),r("button",{onClick:Q(ne=>s(W)(f.id),["stop"])},[G(L,{name:"streamline-freehand:remove-delete-sign-bold"})],8,rt)],10,ot))),128)):(l(),i("li",lt,"Brak produktów w kategorii"))])]))),128)):(l(),i("li",it,"Brak produktów na liście"))]),s(b).length?(l(),i("div",ut,[(l(!0),i(U,null,j(s(b),n=>(l(),i("span",ct,m(n),1))),256))])):M("",!0)])}}});export{mt as default};
