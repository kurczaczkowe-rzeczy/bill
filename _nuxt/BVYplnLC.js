import me from"./CbSy27bm.js";import{_ as fe}from"./uqLJQTKN.js";import{e as ge,m as ve,r as v,f as J,n as K,p as G,q as ye,s as he,x as we,c as l,a as o,g as w,b as $,y as be,w as _e,j as s,h as U,i as j,v as H,d as Q,F as b,l as _,z as ke,A as z,t as m,o as a,B as q}from"./BPsSGsCa.js";import{S as xe,P as Ce,C as Ie,U as D,g as Se}from"./Br3x3BYz.js";import{k as I,u as X}from"./n1fdd4OT.js";const Ae={class:"card flex justify-center flex-col max-w-xl m-auto"},Le={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},$e={class:"px-2 inline-flex flex-row gap-2"},De={class:"list-row-separator"},Ne={class:"btn btn-ghost btn-square"},Ee={class:"relative col-span-2"},Te=["aria-expanded","aria-activedescendant"],Be={key:0,id:"suggestions-list",class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 menu bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Ue={key:0,class:"disabled",role:"presentation"},je=["id","aria-selected","onClick","onMouseenter"],ze={class:"badge badge-ghost badge-sm"},qe={key:2,class:"disabled",role:"presentation"},Me=["value"],Ve={class:"relative col-span-3"},Fe={key:0,class:"flex items-center gap-2"},Oe={key:1,class:"opacity-60"},Pe={key:0,class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Re={key:0,class:"disabled",role:"presentation"},Je=["aria-selected","onClick"],Ke={class:"inline-flex items-center gap-2"},Ge={class:"list"},He=["onClick"],Qe={class:"list-col-grow"},Xe={key:1,class:"list-row"},Ye={key:1,class:"list-row"},Ze={key:0,class:"flex flex-col gap-1"},We={class:"text-error"},lt=ge({__name:"[id]",async setup(et){let g,S;const k=ve(),A=new xe,Y=new Ce,Z=new Ie,M=v(),W=D.values(),{data:u,error:ee,refresh:te,status:ne}=([g,S]=J(async()=>X(`shoppingListDetails:${k.params.id}`,async()=>{if(isNaN(Number(k.params.id)))return[];const e=await A.getShoppingListAsync(k.params.id);if("error"in e)throw new Error(e);if(!("result"in e))throw new Error("Unsupported response type: "+e.constructor.name);return I(e.result)},{server:!1})),g=await g,S(),g),V=K({name:""}),i=K({name:"",quantity:1,unit:D.GRAM,categoryId:1}),F=G(()=>[ee.value,le.value].filter(Boolean)),d=v([]),y=v(!1),L=v(!1),c=v(-1);let N=null;function E(){d.value.length>0&&(y.value=!0)}function h(){y.value=!1,c.value=-1}function O(e){i.name=e.name,i.unit=D.valueOf(e.unit),h()}async function se(e){if(!e||e.trim().length<2){d.value=[],h();return}L.value=!0;try{const t=await Y.getProductSuggestionAsync(i.name);if("error"in t){d.value=[],h();return}if(!("result"in t)){d.value=[],h();return}const r=I(t.result);d.value=r||[],E()}finally{L.value=!1}}ye(()=>i.name,e=>{N&&clearTimeout(N),N=setTimeout(()=>{se(e)},250)});function oe(e){if(!y.value&&(e.key==="ArrowDown"||e.key==="ArrowUp")){E();return}y.value&&(e.key==="ArrowDown"?(e.preventDefault(),c.value=d.value.length===0?-1:(c.value+1)%d.value.length):e.key==="ArrowUp"?(e.preventDefault(),c.value=d.value.length===0?-1:(c.value-1+d.value.length)%d.value.length):e.key==="Enter"?c.value>=0&&c.value<d.value.length&&(e.preventDefault(),O(d.value[c.value])):e.key==="Escape"&&h())}function ae(){setTimeout(()=>h(),100)}const{data:T,error:le,status:re}=([g,S]=J(async()=>X("categories",async()=>{const e=await Z.getCategoriesAsync();if("error"in e)throw new Error(e);if(!("result"in e))throw new Error("Unsupported response type: "+e.constructor.name);return I(e.result)},{server:!1})),g=await g,S(),g),x=v(null),C=v(!1),B=e=>{if(!e)return"";const t=e.split(" ");return t.length>1?t.slice(0,2).map(r=>r[0]).join("").toUpperCase():e.slice(0,2).toUpperCase()},ie=e=>{x.value=e,C.value=!1,i.categoryId=e.id},P=G(()=>u.value&&T.value?I(Se(u.value,T.value)):[]);async function ue(e){if(!u.value)return;const t=u.value.findIndex(f=>f.id===e);if(t===-1||u.value[t]===null||u.value[t]===void 0)return;const r={...u.value[t]};u.value=u.value.toSpliced(t,1,{...r,inCart:!r.inCart}),A.toggleProductInCartAsync(e).then(f=>{"error"in f&&(u.value=u.value?.toSpliced(t,1,r),console.error(f.error))}).catch(f=>{u.value=u.value?.toSpliced(t,1,r),console.error(f)})}async function de(e){if(i.name.trim()===""){V.name="Nazwa powinna być wypełniona";return}A.addToShoppingListAsync(k.params.id,D.valueOf(i.unit.name),i.quantity,i.name,i.categoryId).then(()=>{e.currentTarget?.reset(),ce(),te()})}function ce(){i.name="",i.quantity=1,V.name=""}function pe(e){const t=Array.isArray(e)?e[0]:e;if(t==null)throw new Error(`Invalid list ID. It should be a string or number. Actual value: ${t}`);const r=parseInt(t,10);if(Number.isNaN(r))throw new Error(`Invalid list ID. Is not a number. Actual value: ${t}`);return r}return he(()=>{M.value=A.listenForChangesShoppingList(pe(k.params.id),e=>{const t=I(e),r=u.value?.findIndex(f=>f.id===t.record?.id);r===-1||r===void 0||(u.value=u.value?.toSpliced(r,1,{...u.value[r],inCart:t.record?.inCart??u.value[r]?.inCart}))})}),we(()=>{M.value?.unsubscribe()}),(e,t)=>{const r=me,f=fe;return a(),l("div",Ae,[o("ul",Le,[o("li",$e,[$(f,{to:"/"},{default:_e(()=>[$(r,{name:"streamline-freehand:keyboard-arrow-return"})]),_:1}),s(ne)==="pending"?(a(),be(r,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):w("",!0)]),o("li",De,[o("form",{class:"grid grid-cols-[80px_minmax(0,_auto)_45px]",onSubmit:U(de,["prevent"])},[o("button",Ne,[$(r,{name:"streamline-freehand:add-sign-bold"})]),o("div",Ee,[j(o("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>s(i).name=n),class:"input input-ghost w-full",placeholder:"Nazwa produktu",required:"",type:"text",autocomplete:"off",role:"combobox","aria-autocomplete":"list","aria-expanded":s(y),"aria-controls":"suggestions-list","aria-activedescendant":s(c)>=0?`suggestion-${s(c)}`:void 0,onFocus:t[1]||(t[1]=n=>E()),onBlur:ae,onKeydown:oe},null,40,Te),[[H,s(i).name]]),s(y)?(a(),l("ul",Be,[s(L)?(a(),l("li",Ue,t[8]||(t[8]=[o("span",{class:"loading loading-spinner loading-sm"},null,-1),Q(" Ładowanie… ",-1)]))):s(d).length>0?(a(!0),l(b,{key:1},_(s(d),(n,p)=>(a(),l("li",{id:`suggestion-${p}`,key:n.id||n.name+p,role:"option",class:q(["inline-flex flex-row justify-between items-center",{active:p===s(c)}]),"aria-selected":p===s(c),onClick:R=>O(n),onMouseenter:R=>c.value=p,onMousedown:t[2]||(t[2]=U(()=>{},["prevent"]))},[o("span",null,m(n.name),1),o("span",ze,m(n.unit||"szt."),1)],42,je))),128)):!s(L)&&s(d).length===0?(a(),l("li",qe,t[9]||(t[9]=[o("span",{class:"opacity-60"},"Brak sugestii",-1)]))):w("",!0)])):w("",!0)]),j(o("input",{"onUpdate:modelValue":t[3]||(t[3]=n=>s(i).quantity=n),class:"input input-ghost",min:"1",required:"",type:"number"},null,512),[[H,s(i).quantity]]),j(o("select",{"onUpdate:modelValue":t[4]||(t[4]=n=>s(i).unit=n),class:"select select-ghost col-span-2 w-full"},[t[10]||(t[10]=o("option",{disabled:"",selected:""},"Wybierz jednostkę",-1)),(a(!0),l(b,null,_(s(W),n=>(a(),l("option",{key:n.name,value:n},m(n.name),9,Me))),128))],512),[[ke,s(i).unit]]),o("div",Ve,[o("button",{type:"button",class:"btn btn-ghost w-full justify-between",onClick:t[5]||(t[5]=n=>C.value=!s(C)),onBlur:t[6]||(t[6]=n=>C.value=!1)},[s(x)?(a(),l("div",Fe,[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:z({backgroundColor:`#${s(x).color}`})},m(B(s(x).name)),5),o("span",null,m(s(x).name),1)])):(a(),l("span",Oe,"Wybierz kategorię")),$(r,{name:"mdi:chevron-down",class:"ml-auto"})],32),s(C)?(a(),l("ul",Pe,[s(re)==="pending"?(a(),l("li",Re,t[11]||(t[11]=[o("span",{class:"loading loading-spinner loading-sm"},null,-1),Q(" Ładowanie… ",-1)]))):w("",!0),(a(!0),l(b,null,_(s(T),n=>(a(),l("li",{key:n.id,role:"option",class:q([{active:s(i).categoryId===n.id},"inline-flex flex-row w-full items-center gap-3 px-3 py-2 rounded-lg cursor-pointer hover:bg-base-200"]),"aria-selected":s(i).categoryId===n.id,onMousedown:t[7]||(t[7]=U(()=>{},["prevent"])),onClick:p=>ie(n)},[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:z({backgroundColor:`#${n.color}`})},m(B(n.name)),5),o("span",null,m(n.name),1)],42,Je))),128))])):w("",!0)])],32)]),s(P).length?(a(!0),l(b,{key:0},_(s(P),n=>(a(),l("li",{key:n.category.id,class:"category-list"},[o("span",Ke,[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:z({backgroundColor:`#${n.category.color}`})},m(B(n.category.name)),5),o("span",null,m(n.category.name),1)]),o("ul",Ge,[n.products?.length?(a(!0),l(b,{key:0},_(n.products,p=>(a(),l("li",{key:p.id,class:q([{"line-through":p.inCart},"list-row"]),onClick:R=>ue(p.id)},[o("span",Qe,m(p.name),1),o("span",null,m(p.quantity)+" "+m(p.unit),1)],10,He))),128)):(a(),l("li",Xe,"Brak produktów w kategorii"))])]))),128)):(a(),l("li",Ye,"Brak produktów na liście"))]),s(F).length?(a(),l("div",Ze,[(a(!0),l(b,null,_(s(F),n=>(a(),l("span",We,m(n),1))),256))])):w("",!0)])}}});export{lt as default};
