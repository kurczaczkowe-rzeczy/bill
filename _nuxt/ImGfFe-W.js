import me from"./C3Wt-AmW.js";import{_ as ve}from"./CGCIN-AQ.js";import{m as he,n as B,r as b,p as ue,q as we,s as X,x as ye,y as Y,z as be,e as _e,A as ke,f as ae,B as re,c as i,a,g as $,b as G,C as xe,d as Z,w as Ce,j as o,h as W,i as ee,v as ie,F as j,l as z,D as Ie,E as te,t as h,o as r,G as ne}from"./CvUEPL8y.js";import{S as Le,P as Se,C as Ae,U as M,g as Ee,a as De}from"./C5zEjV6n.js";import{k as R,a as Te,u as de}from"./Cn-xFuF_.js";const q=new Le,Ne=new Se,$e=new Ae,P=l=>l==null;function je(l){if("error"in l)throw new Error(l)}function ze(l){if(!("result"in l))throw new Error("Unsupported response type: "+l.constructor.name);return R(l.result)}function oe(l){return je(l),ze(l)}async function Pe(l,c){const _=he(l),L=B(()=>le(X(_))),T=B(()=>Ee(X(L))),p=b([]),J=b(!1),K=b(null),S=b(new Map),{data:A}=Te("categories"),{data:V,pending:d,error:F,refresh:g}=de(`shoppingListDetails:${L}`,async()=>{const e=await q.getShoppingListAsync(L.value);return oe(e)},{getCachedData(e){const u=be(),f=u.payload.data[e]||u.static.data[e];if(!f)return;const y=new Date(f.fetchedAt);if(y.setTime(y.getTime()+300*1e3),new Date<y)return f},server:!1,...c});ue(V,e=>{e&&(p.value=e)});function w(e){return p.value?.findIndex(u=>u.id===e)??-1}function E(e,u){if(P(e))throw new Error("Invalid product id");p.value[e].inCart=u??p.value[e]?.inCart}function m(e){if(P(e))throw new Error("Invalid product");const u=w(e.id);if(u===-1){p.value.push(e);return}p.value[u]=e}function N(){S.value.has(T.value)&&S.value.get(T.value)?.unsubscribe();async function e(u){const f=R(u),y=w(f.record?.id);if(y===-1||P(y)){if(P(f.oldRecord)&&!P(f.record)){const H=q.getShoppingListProductAsync(f.record.id);if(!A.value)throw new Error("Categories not found");const O=A.value?.find(D=>D.id===f.record?.categoryId)??A.value?.[0];if(!O)throw new Error("Category not found");m({id:f.record.id,createdAt:new Date().toISOString(),quantity:f.record.quantity,unit:M.GRAM.name,name:"Produkt",inCart:f.record.inCart,category:O});try{const D=await H,C=oe(D),k=w(C.id);if(k===-1||k===void 0)throw new Error("Product not found");p.value[k]=C}catch(D){console.error(D)}}return}E(y,f.record?.inCart)}return S.value.set(T.value,q.listenForShoppingListChanges(L.value,e)),S.value.get(T.value)}async function U(e){if(!p.value)throw new Error("Shopping list not found");const u=w(e);if(u===-1||P(p.value[u]))throw new Error("Product not found");const f={...p.value[u]};E(u,p.value[u].inCart),q.toggleProductInCartAsync(e).then(oe).catch(y=>{m(f),console.error(y)})}async function x(e){if(e.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");return q.addToShoppingListAsync(le(e.listId),M.valueOf(e.unit.name),e.quantity,e.name,e.categoryId)}return we(()=>{X(c?.useAutoListenFor)?.includes("shoppingListChanges")&&N()}),ye(()=>{S.value.forEach(e=>{e.unsubscribe()})}),{shoppingListDetails:Y(p),loading:Y(B(()=>d.value||J.value)),error:Y(B(()=>F.value||K.value)),refresh:g,listenForShoppingListChanges:N,toggleInCart:U,addToShoppingList:x,categoriesWithProducts:B(()=>p.value&&A.value?R(De(p.value,A.value)):[])}}function le(l){const c=Array.isArray(l)?l[0]:l;if(c==null)throw new Error(`Invalid list ID. It should be a string or number. Actual value: ${c}`);const _=parseInt(c,10);if(Number.isNaN(_))throw new Error(`Invalid list ID. Is not a number. Actual value: ${c}`);return _}const Be={class:"card flex justify-center flex-col max-w-xl m-auto"},Ue={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},qe={class:"px-2 inline-flex flex-row gap-2"},Me={class:"list-row-separator"},Re={class:"btn btn-ghost btn-square"},Ve={class:"relative col-span-2"},Fe=["aria-expanded","aria-activedescendant"],Oe={key:0,id:"suggestions-list",class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 menu bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Ge={key:0,class:"disabled",role:"presentation"},Je=["id","aria-selected","onClick","onMouseenter"],Ke={class:"badge badge-ghost badge-sm"},He={key:2,class:"disabled",role:"presentation"},Qe=["value"],Xe={class:"relative col-span-3"},Ye={key:0,class:"flex items-center gap-2"},Ze={key:1,class:"opacity-60"},We={key:0,class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},et={key:0,class:"disabled",role:"presentation"},tt=["aria-selected","onClick"],nt={class:"inline-flex items-center gap-2"},ot={class:"list"},st=["onClick"],at={class:"list-col-grow"},rt={key:1,class:"list-row"},it={key:1,class:"list-row"},lt={key:0,class:"flex flex-col gap-1"},ut={class:"text-error"},mt=_e({__name:"[id]",async setup(l){let c,_;const L=ke(),T=M.values(),{categoriesWithProducts:p,error:J,loading:K,toggleInCart:S,addToShoppingList:A}=([c,_]=ae(()=>Pe(L.params.id,{useAutoListenFor:["shoppingListChanges"]})),c=await c,_(),c),V=re({name:""}),d=re({name:"",quantity:1,unit:M.GRAM,categoryId:1}),F=B(()=>[J.value,O.value].filter(Boolean)),g=b([]),w=b(!1),E=b(!1),m=b(-1);let N=null;function U(){g.value.length>0&&(w.value=!0)}function x(){w.value=!1,m.value=-1}function e(s){d.name=s.name,d.unit=M.valueOf(s.unit),x()}async function u(s){if(!s||s.trim().length<2){g.value=[],x();return}E.value=!0;try{const t=await Ne.getProductSuggestionAsync(d.name);if("error"in t){g.value=[],x();return}if(!("result"in t)){g.value=[],x();return}const I=R(t.result);g.value=I||[],U()}finally{E.value=!1}}ue(()=>d.name,s=>{N&&clearTimeout(N),N=setTimeout(()=>{u(s)},250)});function f(s){if(!w.value&&(s.key==="ArrowDown"||s.key==="ArrowUp")){U();return}w.value&&(s.key==="ArrowDown"?(s.preventDefault(),m.value=g.value.length===0?-1:(m.value+1)%g.value.length):s.key==="ArrowUp"?(s.preventDefault(),m.value=g.value.length===0?-1:(m.value-1+g.value.length)%g.value.length):s.key==="Enter"?m.value>=0&&m.value<g.value.length&&(s.preventDefault(),e(g.value[m.value])):s.key==="Escape"&&x())}function y(){setTimeout(()=>x(),100)}const{data:H,error:O,status:D}=([c,_]=ae(async()=>de("categories",async()=>{const s=await $e.getCategoriesAsync();if("error"in s)throw new Error(s);if(!("result"in s))throw new Error("Unsupported response type: "+s.constructor.name);return R(s.result)},{server:!1})),c=await c,_(),c),C=b(null),k=b(!1),Q=s=>{if(!s)return"";const t=s.split(" ");return t.length>1?t.slice(0,2).map(I=>I[0]).join("").toUpperCase():s.slice(0,2).toUpperCase()},ce=s=>{C.value=s,k.value=!1,d.categoryId=s.id};async function pe(s){A({listId:L.params.id,...d}).then(()=>{s.currentTarget?.reset(),ge()}).catch(t=>{V.name=t.message})}function ge(){d.name="",d.quantity=1,V.name=""}return(s,t)=>{const I=me,fe=ve;return r(),i("div",Be,[a("ul",Ue,[a("li",qe,[G(fe,{to:"/"},{default:Ce(()=>[G(I,{name:"streamline-freehand:keyboard-arrow-return"})]),_:1}),o(K)?(r(),xe(I,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):$("",!0),t[8]||(t[8]=Z(" Ilość porduktów które zostały do kupienia i dodaj zwijanie tej wstążki z dodawaniem i by lista była przewijalna a nie cały ekran ",-1))]),a("li",Me,[a("form",{class:"grid grid-cols-[80px_minmax(0,_auto)_45px]",onSubmit:W(pe,["prevent"])},[a("button",Re,[G(I,{name:"streamline-freehand:add-sign-bold"})]),a("div",Ve,[ee(a("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>o(d).name=n),class:"input input-ghost w-full",placeholder:"Nazwa produktu",required:"",type:"text",autocomplete:"off",role:"combobox","aria-autocomplete":"list","aria-expanded":o(w),"aria-controls":"suggestions-list","aria-activedescendant":o(m)>=0?`suggestion-${o(m)}`:void 0,onFocus:t[1]||(t[1]=n=>U()),onBlur:y,onKeydown:f},null,40,Fe),[[ie,o(d).name]]),o(w)?(r(),i("ul",Oe,[o(E)?(r(),i("li",Ge,t[9]||(t[9]=[a("span",{class:"loading loading-spinner loading-sm"},null,-1),Z(" Ładowanie… ",-1)]))):o(g).length>0?(r(!0),i(j,{key:1},z(o(g),(n,v)=>(r(),i("li",{id:`suggestion-${v}`,key:n.id||n.name+v,role:"option",class:ne(["inline-flex flex-row justify-between items-center",{active:v===o(m)}]),"aria-selected":v===o(m),onClick:se=>e(n),onMouseenter:se=>m.value=v,onMousedown:t[2]||(t[2]=W(()=>{},["prevent"]))},[a("span",null,h(n.name),1),a("span",Ke,h(n.unit||"szt."),1)],42,Je))),128)):!o(E)&&o(g).length===0?(r(),i("li",He,t[10]||(t[10]=[a("span",{class:"opacity-60"},"Brak sugestii",-1)]))):$("",!0)])):$("",!0)]),ee(a("input",{"onUpdate:modelValue":t[3]||(t[3]=n=>o(d).quantity=n),class:"input input-ghost",min:"1",required:"",type:"number"},null,512),[[ie,o(d).quantity]]),ee(a("select",{"onUpdate:modelValue":t[4]||(t[4]=n=>o(d).unit=n),class:"select select-ghost col-span-2 w-full"},[t[11]||(t[11]=a("option",{disabled:"",selected:""},"Wybierz jednostkę",-1)),(r(!0),i(j,null,z(o(T),n=>(r(),i("option",{key:n.name,value:n},h(n.name),9,Qe))),128))],512),[[Ie,o(d).unit]]),a("div",Xe,[a("button",{type:"button",class:"btn btn-ghost w-full justify-between",onClick:t[5]||(t[5]=n=>k.value=!o(k)),onBlur:t[6]||(t[6]=n=>k.value=!1)},[o(C)?(r(),i("div",Ye,[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:te({backgroundColor:`#${o(C).color}`})},h(Q(o(C).name)),5),a("span",null,h(o(C).name),1)])):(r(),i("span",Ze,"Wybierz kategorię")),G(I,{name:"mdi:chevron-down",class:"ml-auto"})],32),o(k)?(r(),i("ul",We,[o(D)==="pending"?(r(),i("li",et,t[12]||(t[12]=[a("span",{class:"loading loading-spinner loading-sm"},null,-1),Z(" Ładowanie… ",-1)]))):$("",!0),(r(!0),i(j,null,z(o(H),n=>(r(),i("li",{key:n.id,role:"option",class:ne([{active:o(d).categoryId===n.id},"inline-flex flex-row w-full items-center gap-3 px-3 py-2 rounded-lg cursor-pointer hover:bg-base-200"]),"aria-selected":o(d).categoryId===n.id,onMousedown:t[7]||(t[7]=W(()=>{},["prevent"])),onClick:v=>ce(n)},[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:te({backgroundColor:`#${n.color}`})},h(Q(n.name)),5),a("span",null,h(n.name),1)],42,tt))),128))])):$("",!0)])],32)]),o(p).length?(r(!0),i(j,{key:0},z(o(p),n=>(r(),i("li",{key:n.category.id,class:"category-list"},[a("span",nt,[a("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:te({backgroundColor:`#${n.category.color}`})},h(Q(n.category.name)),5),a("span",null,h(n.category.name),1)]),a("ul",ot,[n.products?.length?(r(!0),i(j,{key:0},z(n.products,v=>(r(),i("li",{key:v.id,class:ne([{"line-through":v.inCart},"list-row"]),onClick:se=>o(S)(v.id)},[a("span",at,h(v.name),1),a("span",null,h(v.quantity)+" "+h(v.unit),1)],10,st))),128)):(r(),i("li",rt,"Brak produktów w kategorii"))])]))),128)):(r(),i("li",it,"Brak produktów na liście"))]),o(F).length?(r(),i("div",lt,[(r(!0),i(j,null,z(o(F),n=>(r(),i("span",ut,h(n),1))),256))])):$("",!0)])}}});export{mt as default};
