import{e as U,f as z,c as v,o as g,r as F,g as x,F as M,h as P,i as c,j as E,k,l as q,m as J,n as G,p as H,q as R,s as K,b,w as N,d as j,a as l,t as A,v as Q,x as W,y as X,z as Y,A as Z}from"./CWJtsIFS.js";import{_ as ee}from"./BuZE7V5f.js";import{getShoppingListsChannelName as te}from"./D2EYCBkt.js";import{u as ne,s as y,r as $,a as se,k as ae,g as oe,h as ie}from"./Bb7BTnTJ.js";const re={class:"list"},le={key:1,class:"list-row"},ce=U({__name:"BaseList",props:{items:{}},setup(L){const s=L,o=z();return(u,d)=>(g(),v("ul",re,[F(u.$slots,"static"),s.items?.length?(g(!0),v(M,{key:0},P(s.items,f=>(g(),v("li",{class:"list-row",key:f.id},[F(u.$slots,"item",{item:f})]))),128)):x("",!0),!s.items?.length&&c(o).empty?(g(),v("li",le,[F(u.$slots,"empty")])):x("",!0)]))}}),de=Object.assign(ce,{__name:"BaseList"});async function ue(L){const s=E(()=>te()),o=k(!1),u=k(null),d=k(new Map),{data:f,pending:B,error:I,refresh:O}=ne("shoppingLists",async()=>{const e=await y.getShoppingListsAsync();return $(e)},{getCachedData(e){const n=q(),t=n.payload.data[e]||n.static.data[e];if(!t)return;const a=new Date(t.fetchedAt);if(a.setTime(a.getTime()+300*1e3),new Date<a)return t},server:!1,...L}),{listToSync:_,getItem:p,upsertItem:r,deleteItem:C,releaseAction:S,isActionBlocked:D,blockAction:h}=se(f);async function i(){d.value.has(s.value)&&d.value.get(s.value)&&y.unsubscribe(d.value.get(s.value));async function e(n){try{const t=ae(n),a=oe(t);if(D(t.record?.id??t.oldRecord?.id,a))return;switch(a){case"insert":{r({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date,productAmount:t.record.productAmount},0);break}case"update":r({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date});break;case"delete":C(t.oldRecord.id);break;default:throw new Error("Invalid payload")}}catch(t){console.error(t)}}return d.value.set(s.value,y.listenForShoppingListsChanges(e)),d.value.get(s.value)}async function w(e){if(e.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");o.value=!0;const n=new Date,t=n.valueOf()*2;return h(t,"insert"),r({id:t,createdAt:n.toISOString(),name:e.name,date:new Intl.DateTimeFormat("pl-PL").format(n),productAmount:0},0),y.createShoppingListAsync(e.name).then(a=>{const V=$(a);return r(V,0,!0),a}).catch(a=>(console.error(a),a)).finally(()=>{o.value=!1,S(t,"insert")})}async function T(e){if(e.name?.trim()==="")throw new Error("Nazwa powinna być wypełniona");const n=p(e.id);return o.value=!0,h(e.id,"update"),r({...e},n.index),y.updateShoppingListAsync(e.id,e.name,e.date).then(t=>{const a=$(t);return r(a,n.index),t}).catch(t=>(console.error(t),r(n.item,n.index),t)).finally(()=>{o.value=!1,S(e.id,"update")})}async function m(e){const n=p(e.id);return o.value=!0,h(e.id,"delete"),C(e.id),y.deleteShoppingListAsync(e.id).catch(t=>(console.error(t),r(n.item,n.index),t)).finally(()=>{o.value=!1,S(e.id,"delete")})}return J(()=>{G(L?.useAutoListenFor)?.includes("shoppingListsChanges")&&i()}),H(()=>{try{d.value.forEach(e=>{y.unsubscribe(e)})}catch(e){console.error(e)}}),{shoppingLists:R(_),loading:R(E(()=>B.value||o.value)),error:R(E(()=>I.value||u.value)),refresh:O,listenForShoppingListsChanges:i,addShoppingList:w,updateShoppingList:T,deleteShoppingList:m}}const pe={class:"card flex justify-center max-w-xl m-auto"},he={class:"p-4 grid grid-cols-[80px_1fr]"},me={class:"col-2 justify-self-end"},ge={class:"list-col-grow"},fe=["aria-invalid","placeholder"],_e={key:0,class:"validator-hint hidden"},ye={class:"btn btn-ghost btn-circle"},ve=["onClick"],we={key:0},xe=U({__name:"index",async setup(L){let s,o;const{shoppingLists:u,loading:d,error:f,addShoppingList:B,deleteShoppingList:I,updateShoppingList:O}=([s,o]=K(()=>ue({useAutoListenFor:["shoppingListsChanges"]})),s=await s,o(),s),_=k(""),p=k("");async function r(h){B({name:p.value||D()}).then(i=>{ie(i),h.currentTarget?.reset(),S()}).catch(i=>{_.value=i.toString()})}async function C(h){I({id:h})}function S(){p.value="",_.value=""}function D(){return new Intl.DateTimeFormat("pl-PL").format(new Date)}return(h,i)=>{const w=Q,T=ee;return g(),v("div",pe,[b(de,{class:"card-body bg-base-100 rounded-box shadow-md w-full",items:c(u)},{static:N(()=>[l("li",he,[c(d)?(g(),W(w,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):x("",!0),l("span",me,"List: "+A(c(u).length),1)]),l("li",null,[l("form",{class:"list-row",onSubmit:r},[l("label",ge,[X(l("input",{"onUpdate:modelValue":i[0]||(i[0]=m=>Y(p)?p.value=m:null),"aria-invalid":!!c(_),class:"input input-ghost validator",placeholder:D(),type:"text"},null,8,fe),[[Z,c(p)]]),c(_).trim()?(g(),v("span",_e,A(c(_)),1)):x("",!0)]),l("button",ye,[b(w,{name:"streamline-freehand:add-sign-bold"})])],32)])]),item:N(({item:m})=>[b(T,{to:{name:"lists-id",params:{id:m.id}},class:"list-col-grow"},{default:N(()=>[l("span",null,A(m.name),1)]),_:2},1032,["to"]),l("span",null,[j(A(m.productAmount)+" ",1),b(w,{name:"streamline-freehand:shopping-cart-trolley"})]),l("button",{onClick:e=>C(m.id)},[b(w,{name:"streamline-freehand:remove-delete-sign-bold"})],8,ve)]),empty:N(()=>i[1]||(i[1]=[j("Brak list",-1)])),_:1},8,["items"]),c(f)?(g(),v("div",we,A(c(f)),1)):x("",!0)])}}});export{xe as default};
