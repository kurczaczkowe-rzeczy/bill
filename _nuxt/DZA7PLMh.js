import{A as fe,e as j,r as x,g as me,h as W,i as he,j as ee,f as ve,k as ye,B as we,l as le,C as ie,D as be,c as i,a as o,m as q,b as K,n as _e,w as ke,p as n,q as te,s as ne,v as ue,d as ce,F as M,z as U,E as xe,G as se,t as h,o as l,y as Ce,H as oe}from"./qcYDViHw.js";import{_ as Ie}from"./kj6-xdrY.js";import{UnitEnum as O,getShoppingListChannelName as Le,groupProductsByCategoryJs as Ae}from"./sjsuxzjh.js";import{b as Se,u as pe,s as A,r as V,a as De,k as H,g as Ee,c as Te,p as Ne}from"./GvR_L9BH.js";async function Pe(P,c){const _=fe(P),S=j(()=>de(W(_))),D=j(()=>Le(W(S))),C=x(!1),Q=x(null),I=x(new Map),{data:b}=Se("categories"),{data:X,pending:ae,error:G,refresh:u}=pe(`shoppingListDetails:${S.value}`,async()=>{const r=await A.getShoppingListAsync(S.value);return V(r)},{getCachedData(r){const g=ve(),a=g.payload.data[r]||g.static.data[r];if(!a)return;const v=new Date(a.fetchedAt);if(v.setTime(v.getTime()+300*1e3),new Date<v)return a},server:!1,...c}),{listToSync:E,getItem:d,upsertItem:f,deleteItem:$,releaseAction:p,isActionBlocked:z,blockAction:B}=De(X);async function k(){I.value.has(D.value)&&I.value.get(D.value)&&A.unsubscribe(I.value.get(D.value));async function r(g){try{const a=H(g),v=Ee(a);if(z(a.record?.id??a.oldRecord?.id,v))return;switch(v){case"insert":{const y=A.getShoppingListProductAsync(a.record.id);if(!b.value)throw new Error("Categories not found");const w=b.value?.find(R=>R.id===a.record?.categoryId)??b.value?.[0];if(!w)throw new Error("Category not found");f({id:a.record.id,createdAt:new Date().toISOString(),quantity:a.record.quantity,unit:O.GRAM.name,name:"Ładowanie...",inCart:a.record.inCart,category:w});const N=await y,F=V(N);f(F);break}case"update":{const y=A.getShoppingListProductAsync(a.record.id);if(!b.value)throw new Error("Categories not found");if(!(b.value?.find(R=>R.id===a.record?.categoryId)??b.value?.[0]))throw new Error("Category not found");f(a.record);const N=await y,F=V(N);f(F);break}case"delete":$(a.oldRecord.id);break;default:throw new Error("Invalid payload")}}catch(a){console.error(a)}}return I.value.set(D.value,A.listenForShoppingListChanges(S.value,r)),I.value.get(D.value)}async function J(r){if(!E.value)throw new Error("Shopping list not found");const g=d(r);if(!g.item)throw new Error("Product not found");C.value=!0,B(r,"update"),f({id:g.item.id,inCart:g.item.inCart},g.index,!0),A.toggleProductInCartAsync(r).then(a=>{const v=V(a);f(v,g.index,!0)}).catch(a=>{f(g.item,g.index,!0),console.error(a)}).finally(()=>{C.value=!1,p(r,"update")})}async function Y(r,g,a,v){if(r.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");C.value=!0;const y=new Date().valueOf()*2;B(y,"insert"),A.addToShoppingListAsync(de(r.listId),O.valueOf(r.unit.name),r.quantity,r.name,r.categoryId).then(w=>{const N=V(w);g?.(N)}).catch(w=>{console.error(w),a?.(w)}).finally(()=>{C.value=!1,p(y,"insert"),v?.()})}async function Z(r){console.log("Not Implemented->")}return me(()=>{W(c?.useAutoListenFor)?.includes("shoppingListChanges")&&k()}),he(()=>{try{I.value.forEach(r=>{A.unsubscribe(r)})}catch(r){console.error(r)}}),{shoppingListDetails:ee(E),loading:ee(j(()=>ae.value||C.value)),error:ee(j(()=>G.value||Q.value)),refresh:u,listenForShoppingListChanges:k,toggleInCart:J,addToShoppingList:Y,deleteProductFromShoppingList:Z,categoriesWithProducts:j(()=>E.value&&b.value?H(Ae(E.value,b.value)):[])}}function de(P){const c=Array.isArray(P)?P[0]:P;if(c==null)throw new Error(`Invalid list ID. It should be a string or number. Actual value: ${c}`);const _=parseInt(c,10);if(Number.isNaN(_))throw new Error(`Invalid list ID. Is not a number. Actual value: ${c}`);return _}const $e={class:"card flex justify-center flex-col max-w-xl m-auto"},Be={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},qe={class:"px-2 inline-flex flex-row gap-2"},Me={class:"list-row-separator"},Ue={class:"btn btn-ghost btn-square"},je={class:"relative col-span-2"},ze=["aria-expanded","aria-activedescendant"],Fe={key:0,id:"suggestions-list",class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 menu bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Re={key:0,class:"disabled",role:"presentation"},Ve=["id","aria-selected","onClick","onMouseenter"],Oe={class:"badge badge-ghost badge-sm"},Ge={key:2,class:"disabled",role:"presentation"},Je=["value"],Ke={class:"relative col-span-3"},He={key:0,class:"flex items-center gap-2"},Qe={key:1,class:"opacity-60"},Xe={key:0,class:"border-1 w-full absolute top-full left-0 right-0 mt-1 z-20 bg-base-100 rounded-box shadow-lg max-h-64 overflow-auto p-2",role:"listbox"},Ye={key:0,class:"disabled",role:"presentation"},Ze=["aria-selected","onClick"],We={class:"inline-flex items-center gap-2"},et={class:"list"},tt=["onClick"],nt={class:"list-col-grow"},st={key:1,class:"list-row"},ot={key:1,class:"list-row"},at={key:0,class:"flex flex-col gap-1"},rt={class:"text-error"},dt=ye({__name:"[id]",async setup(P){let c,_;const S=we(),D=O.values(),{categoriesWithProducts:C,error:Q,loading:I,toggleInCart:b,addToShoppingList:X,deleteProductFromShoppingList:ae}=([c,_]=le(()=>Pe(S.params.id,{useAutoListenFor:["shoppingListChanges"]})),c=await c,_(),c),G=ie({name:""}),u=ie({name:"",quantity:1,unit:O.GRAM,categoryId:1}),E=j(()=>[Q.value,a.value].filter(Boolean)),d=x([]),f=x(!1),$=x(!1),p=x(-1);let z=null;function B(){d.value.length>0&&(f.value=!0)}function k(){f.value=!1,p.value=-1}function J(s){try{u.name=s.name,u.unit=O.valueOf(s.unit),k()}catch(e){console.error("selectSuggestion->",e)}}async function Y(s){if(!s||s.trim().length<2){d.value=[],k();return}$.value=!0;try{const e=await Ne.getProductSuggestionAsync(u.name);if("error"in e){d.value=[],k();return}if(!("result"in e)){d.value=[],k();return}const L=H(e.result);d.value=L||[],B()}finally{$.value=!1}}be(()=>u.name,s=>{z&&clearTimeout(z),z=setTimeout(()=>{Y(s)},250)});function Z(s){if(!f.value&&(s.key==="ArrowDown"||s.key==="ArrowUp")){B();return}f.value&&(s.key==="ArrowDown"?(s.preventDefault(),p.value=d.value.length===0?-1:(p.value+1)%d.value.length):s.key==="ArrowUp"?(s.preventDefault(),p.value=d.value.length===0?-1:(p.value-1+d.value.length)%d.value.length):s.key==="Enter"?p.value>=0&&p.value<d.value.length&&(s.preventDefault(),J(d.value[p.value])):s.key==="Escape"&&k())}function r(){setTimeout(()=>k(),100)}const{data:g,error:a,status:v}=([c,_]=le(async()=>pe("categories",async()=>{const s=await Te.getCategoriesAsync();if("error"in s)throw new Error(s);if(!("result"in s))throw new Error("Unsupported response type: "+s.constructor.name);return H(s.result)},{server:!1})),c=await c,_(),c),T=x(null),y=x(!1),w=s=>{if(!s)return"";const e=s.split(" ");return e.length>1?e.slice(0,2).map(L=>L[0]).join("").toUpperCase():s.slice(0,2).toUpperCase()},N=s=>{T.value=s,y.value=!1,u.categoryId=s.id};async function F(s){X({listId:S.params.id,...u},()=>{s.currentTarget?.reset(),R()},e=>{G.name=e.message})}function R(){u.name="",u.quantity=1,G.name=""}return(s,e)=>{const L=Ce,ge=Ie;return l(),i("div",$e,[o("ul",Be,[o("li",qe,[K(ge,{to:"/"},{default:ke(()=>[K(L,{name:"streamline-freehand:keyboard-arrow-return"})]),_:1}),n(I)?(l(),_e(L,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):q("",!0)]),o("li",Me,[o("form",{class:"grid grid-cols-[80px_minmax(0,_auto)_45px]",onSubmit:te(F,["prevent"])},[o("button",Ue,[K(L,{name:"streamline-freehand:add-sign-bold"})]),o("div",je,[ne(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>n(u).name=t),class:"input input-ghost w-full",placeholder:"Nazwa produktu",required:"",type:"text",autocomplete:"off",role:"combobox","aria-autocomplete":"list","aria-expanded":n(f),"aria-controls":"suggestions-list","aria-activedescendant":n(p)>=0?`suggestion-${n(p)}`:void 0,onFocus:e[1]||(e[1]=t=>B()),onBlur:r,onKeydown:Z},null,40,ze),[[ue,n(u).name]]),n(f)?(l(),i("ul",Fe,[n($)?(l(),i("li",Re,e[8]||(e[8]=[o("span",{class:"loading loading-spinner loading-sm"},null,-1),ce(" Ładowanie… ",-1)]))):n(d).length>0?(l(!0),i(M,{key:1},U(n(d),(t,m)=>(l(),i("li",{id:`suggestion-${m}`,key:t.id||t.name+m,role:"option",class:oe(["inline-flex flex-row justify-between items-center",{active:m===n(p)}]),"aria-selected":m===n(p),onClick:re=>J(t),onMouseenter:re=>p.value=m,onMousedown:e[2]||(e[2]=te(()=>{},["prevent"]))},[o("span",null,h(t.name),1),o("span",Oe,h(t.unit||"szt."),1)],42,Ve))),128)):!n($)&&n(d).length===0?(l(),i("li",Ge,e[9]||(e[9]=[o("span",{class:"opacity-60"},"Brak sugestii",-1)]))):q("",!0)])):q("",!0)]),ne(o("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>n(u).quantity=t),class:"input input-ghost",min:"1",required:"",type:"number"},null,512),[[ue,n(u).quantity]]),ne(o("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>n(u).unit=t),class:"select select-ghost col-span-2 w-full"},[e[10]||(e[10]=o("option",{disabled:"",selected:""},"Wybierz jednostkę",-1)),(l(!0),i(M,null,U(n(D),t=>(l(),i("option",{key:t.name,value:t},h(t.name),9,Je))),128))],512),[[xe,n(u).unit]]),o("div",Ke,[o("button",{type:"button",class:"btn btn-ghost w-full justify-between",onClick:e[5]||(e[5]=t=>y.value=!n(y)),onBlur:e[6]||(e[6]=t=>y.value=!1)},[n(T)?(l(),i("div",He,[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:se({backgroundColor:`#${n(T).color}`})},h(w(n(T).name)),5),o("span",null,h(n(T).name),1)])):(l(),i("span",Qe,"Wybierz kategorię")),K(L,{name:"mdi:chevron-down",class:"ml-auto"})],32),n(y)?(l(),i("ul",Xe,[n(v)==="pending"?(l(),i("li",Ye,e[11]||(e[11]=[o("span",{class:"loading loading-spinner loading-sm"},null,-1),ce(" Ładowanie… ",-1)]))):q("",!0),(l(!0),i(M,null,U(n(g),t=>(l(),i("li",{key:t.id,role:"option",class:oe([{active:n(u).categoryId===t.id},"inline-flex flex-row w-full items-center gap-3 px-3 py-2 rounded-lg cursor-pointer hover:bg-base-200"]),"aria-selected":n(u).categoryId===t.id,onMousedown:e[7]||(e[7]=te(()=>{},["prevent"])),onClick:m=>N(t)},[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:se({backgroundColor:`#${t.color}`})},h(w(t.name)),5),o("span",null,h(t.name),1)],42,Ze))),128))])):q("",!0)])],32)]),n(C).length?(l(!0),i(M,{key:0},U(n(C),t=>(l(),i("li",{key:t.category.id,class:"category-list"},[o("span",We,[o("span",{class:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-sm",style:se({backgroundColor:`#${t.category.color}`})},h(w(t.category.name)),5),o("span",null,h(t.category.name),1)]),o("ul",et,[t.products?.length?(l(!0),i(M,{key:0},U(t.products,m=>(l(),i("li",{key:m.id,class:oe([{"line-through":m.inCart},"list-row"]),onClick:re=>n(b)(m.id)},[o("span",nt,h(m.name),1),o("span",null,h(m.quantity)+" "+h(m.unit),1)],10,tt))),128)):(l(),i("li",st,"Brak produktów w kategorii"))])]))),128)):(l(),i("li",ot,"Brak produktów na liście"))]),n(E).length?(l(),i("div",at,[(l(!0),i(M,null,U(n(E),t=>(l(),i("span",rt,h(t),1))),256))])):q("",!0)])}}});export{dt as default};
