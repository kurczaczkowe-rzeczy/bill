import{r as b,e as M,f as V,g as R,h as j,i as z,j as q,k as F,l as $,m as H,c as E,o as x,a as d,n as B,p as J,q as g,t as C,s as G,v as K,x as Q,y as W,b as I,z as X,F as Y,A as Z,w as ee,d as te}from"./C4lLsOEO.js";import{_ as ne}from"./BNSO_T1m.js";import{getShoppingListsChannelName as se}from"./Bx0rNsYC.js";import{i as L,u as oe,s as S,r as P,k as ae,h as re}from"./Dp28m5vB.js";function ie(l){const a=b([]),o=b(new Map);function y(e,n){if(o.value.has(e)){o.value.get(e).push(n);return}o.value.set(e,[n])}function p(e,n){if(!o.value.has(e))return;const i=o.value.get(e)?.filter(f=>f!==n);if(i.length===0){o.value.delete(e);return}o.value.set(e,i)}function k(e){const n=o.value.values();let i=n.next().value;for(;i!==void 0;){if(i.includes(e))return!0;i=n.next().value}return!1}function D(e,n){return!o.value.has(e)&&k("insert")?!0:o.value.has(e)?o.value.get(e).includes(n):!1}function T(e){const n=A(e);return{list:a.value?.[n],index:n}}function A(e){return a.value?.findIndex(n=>n.id===e)??-1}function v(e,n,i){if(L(e))throw new Error("Invalid product");const f=A(e.id),m=!L(n)&&n>-1?n:f;if(m===-1)return a.value.push(e)-1;const u=f>-1||i?1:0,w=u>0?{...a.value[f],...e}:e;return a.value.splice(m,u,w),m}function h(e){const n=A(e);n!==-1&&a.value.splice(n,1)}return M(l,e=>{const n=V(e);n&&(a.value=n)}),{listToSync:a,getList:T,getListIndex:A,upsertProduct:v,deleteList:h,blockAction:y,releaseAction:p,isActionBlocked:D}}const U={UPDATE:"update",INSERT:"insert",DELETE:"delete"};function ce(l){if(!L(l.record)&&L(l.oldRecord))return U.INSERT;if(!L(l.record)&&!L(l.oldRecord))return U.UPDATE;if(L(l.record)&&!L(l.oldRecord))return U.DELETE;throw new Error("Unknown channel action")}async function le(l){const a=R(()=>se()),o=b(!1),y=b(null),p=b(new Map),{data:k,pending:D,error:T,refresh:A}=oe("shoppingLists",async()=>{const s=await S.getShoppingListsAsync();return P(s)},{getCachedData(s){const r=j(),t=r.payload.data[s]||r.static.data[s];if(!t)return;const c=new Date(t.fetchedAt);if(c.setTime(c.getTime()+300*1e3),new Date<c)return t},server:!1,...l}),{listToSync:v,getList:h,upsertProduct:e,deleteList:n,releaseAction:i,isActionBlocked:f,blockAction:m}=ie(k);async function u(){p.value.has(a.value)&&p.value.get(a.value)&&S.unsubscribe(p.value.get(a.value));async function s(r){try{const t=ae(r),c=ce(t);if(f(t.record?.id??t.oldRecord?.id,c))return;switch(c){case"insert":{e({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date,productAmount:t.record.productAmount},0);break}case"update":e({id:t.record.id,createdAt:new Date().toISOString(),name:t.record.name,date:t.record.date});break;case"delete":n(t.oldRecord.id);break;default:throw new Error("Invalid payload")}}catch(t){console.error(t)}}return p.value.set(a.value,S.listenForShoppingListsChanges(s)),p.value.get(a.value)}async function w(s){if(s.name.trim()==="")throw new Error("Nazwa powinna być wypełniona");o.value=!0;const r=new Date,t=r.valueOf()*2;return m(t,"insert"),e({id:t,createdAt:r.toISOString(),name:s.name,date:new Intl.DateTimeFormat("pl-PL").format(r),productAmount:0},0),S.createShoppingListAsync(s.name).then(c=>{const O=P(c);return e(O,0,!0),c}).catch(c=>(console.error(c),c)).finally(()=>{o.value=!1,i(t,"insert")})}async function N(s){if(s.name?.trim()==="")throw new Error("Nazwa powinna być wypełniona");const r=h(s.id);return e({...s},r.index),S.updateShoppingListAsync(s.id,s.name,s.date).then(t=>{const c=P(t);return e(c,r.index),t}).catch(t=>(console.error(t),e(r.list,r.index),t)).finally(()=>{o.value=!1})}async function _(s){const r=h(s.id);return o.value=!0,n(s.id),S.deleteShoppingListAsync(s.id).catch(t=>(console.error(t),e(r.list,r.index),t)).finally(()=>{o.value=!1})}return z(()=>{V(l?.useAutoListenFor)?.includes("shoppingListsChanges")&&u()}),q(()=>{try{p.value.forEach(s=>{S.unsubscribe(s)})}catch(s){console.error(s)}}),{shoppingLists:F(v),loading:F(R(()=>D.value||o.value)),error:F(R(()=>T.value||y.value)),refresh:A,listenForShoppingListsChanges:u,addShoppingList:w,updateShoppingList:N,deleteShoppingList:_}}const ue={class:"card flex justify-center max-w-xl m-auto"},de={class:"card-body list bg-base-100 rounded-box shadow-md w-full"},pe={class:"p-4 grid grid-cols-[80px_1fr]"},he={class:"col-2 justify-self-end"},fe={class:"list-col-grow"},me=["aria-invalid","placeholder"],ge={key:0,class:"validator-hint hidden"},ve={class:"btn btn-ghost btn-square"},_e=["onClick"],we={key:1,class:"list-row"},Le={key:0},be=$({__name:"index",async setup(l){let a,o;const{shoppingLists:y,loading:p,error:k,addShoppingList:D,deleteShoppingList:T,updateShoppingList:A}=([a,o]=H(()=>le({useAutoListenFor:["shoppingListsChanges"]})),a=await a,o(),a),v=b(""),h=b("");async function e(m){D({name:h.value||f()}).then(u=>{re(u),m.currentTarget?.reset(),i()}).catch(u=>{v.value=u.toString()})}async function n(m){T({id:m})}function i(){h.value="",v.value=""}function f(){return new Intl.DateTimeFormat("pl-PL").format(new Date)}return(m,u)=>{const w=X,N=ne;return x(),E("div",ue,[d("ul",de,[d("li",pe,[g(p)?(x(),J(w,{key:0,class:"animate-spin text-info",name:"streamline-freehand:loading-star-1"})):B("",!0),d("span",he,"List: "+C(g(y).length),1)]),d("li",null,[d("form",{class:"list-row",onSubmit:G(e,["prevent"])},[d("label",fe,[K(d("input",{"onUpdate:modelValue":u[0]||(u[0]=_=>W(h)?h.value=_:null),"aria-invalid":!!g(v),class:"input input-ghost validator",placeholder:f(),type:"text"},null,8,me),[[Q,g(h)]]),g(v).trim()?(x(),E("span",ge,C(g(v)),1)):B("",!0)]),d("button",ve,[I(w,{name:"streamline-freehand:add-sign-bold"})])],32)]),g(y)?.length?(x(!0),E(Y,{key:0},Z(g(y),_=>(x(),E("li",{key:_.id,class:"list-row"},[I(N,{to:{name:"lists-id",params:{id:_.id}},class:"list-col-grow"},{default:ee(()=>[d("span",null,C(_.name),1)]),_:2},1032,["to"]),d("span",null,[te(C(_.productAmount)+" ",1),I(w,{name:"streamline-freehand:shopping-cart-trolley"})]),d("button",{onClick:s=>n(_.id)},[I(w,{name:"streamline-freehand:remove-delete-sign-bold"})],8,_e)]))),128)):(x(),E("li",we,"Brak list"))]),g(k)?(x(),E("div",Le,C(g(k)),1)):B("",!0)])}}});export{be as default};
